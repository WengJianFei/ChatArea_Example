var it=Object.defineProperty;var nt=(u,t,e)=>t in u?it(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var C=(u,t,e)=>(nt(u,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();function st(){const u=navigator.userAgent,t=/(?:Windows Phone)/.test(u),e=/(?:SymbianOS)/.test(u)||t,i=/(?:Android)/.test(u),s=/(?:Firefox)/.test(u),n=/(?:iPad|PlayBook)/.test(u)||i&&!/(?:Mobile)/.test(u)||s&&/(?:Tablet)/.test(u),a=/(?:iPhone)/.test(u)&&!n;return{isTablet:n,isPhone:a,isAndroid:i,isPc:!a&&!i&&!e}}function f(u,t=!1,e="block"){u&&(u.className=u.className.replace(/ chat-view-show| chat-view-hidden/g,""),t?(u.style.display=e,u.className+=" chat-view-show"):(u.className+=" chat-view-hidden",u.style.display="none"))}function $(u){return u&&u.classList.contains("chat-view-show")}function T(u,t,e){u.classList[e?"add":"remove"](t)}const I="data-set-empty",E="data-set-richType",tt="richWrap",H="richGrid",b="richMark",_="richInput",M="richTag",U=(u=50)=>new Promise(t=>{setTimeout(t,u)}),q=u=>String(u)!=="false"&&String(u)!=="null"&&String(u)!=="0",Y=(u,t,e=!1)=>{let i;return function(...s){const n=this,a=()=>{i=null,e||u.apply(n,s)},l=e&&!i;clearTimeout(i),i=setTimeout(a,t),l&&u.apply(n,s)}},z=(u,t)=>{let e;return function(...i){const s=this;e||(u.apply(s,i),e=!0,setTimeout(function(){e=!1},t))}},W=(u,t,e)=>(u=u.toLowerCase(),t=t.toLowerCase(),e=e.toLowerCase(),e=e.replace(/\s/g,""),!/[\p{P}\p{S}]/u.test(e)&&at(u,t||u,e)),at=(u,t,e)=>{if(!e)return!1;const{chinesePart:i,pinyinPart:s,numberPart:n}=lt(e);if(i&&!u.startsWith(i)||n&&!u.includes(n))return!1;const a=t.replace(/\s+/g,"").toLowerCase();return!(s&&!rt(s,a))},lt=u=>{let t="",e="",i="",s=null;for(const n of u)ot(n)?(s="chinese",t+=n):/[a-zA-Z]/.test(n)?(s="pinyin",e+=n.toLowerCase()):/\d/.test(n)?(s="number",i+=n):s=null;return{chinesePart:t,pinyinPart:e,numberPart:i,currentType:s}},ot=u=>{const t=u.charCodeAt(0);return t>=19968&&t<=40959||t>=13312&&t<=19903||t>=131072&&t<=173791},rt=(u,t)=>{let e=0;for(const i of t){if(e>=u.length)break;i===u[e]&&e++}return e===u.length},et=(u,t)=>{const e=u.getAttribute(E);return e===H?null:e===b||e===M?u:u.parentElement&&t>0?et(u.parentElement,t-1):null},G=(u,t,e)=>u&&u[t]?u[t]:e,ct='<svg class="check-empty-svg" viewBox="0 0 64 41" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0 1)" fill="none" fill-rule="evenodd"><ellipse fill="#f5f5f5" cx="32" cy="33" rx="32" ry="7"></ellipse><g fill-rule="nonzero" stroke="#d9d9d9"><path d="M55 12.76L44.854 1.258C44.367.474 43.656 0 42.907 0H21.093c-.749 0-1.46.474-1.947 1.257L9 12.761V22h46v-9.24z"></path><path d="M41.613 15.931c0-1.605.994-2.93 2.227-2.931H55v18.137C55 33.26 53.68 35 52.05 35h-40.1C10.32 35 9 33.259 9 31.137V13h11.16c1.233 0 2.227 1.323 2.227 2.928v.022c0 1.605 1.005 2.901 2.237 2.901h14.752c1.232 0 2.237-1.308 2.237-2.913v-.007z" fill="#fafafa"></path></g></g></svg>',ht='<svg class="empty-svg" viewBox="0 0 64 41" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0 1)" fill="none" fill-rule="evenodd"><ellipse fill="#f5f5f5" cx="32" cy="33" rx="32" ry="7"></ellipse><g fill-rule="nonzero" stroke="#d9d9d9"><path d="M55 12.76L44.854 1.258C44.367.474 43.656 0 42.907 0H21.093c-.749 0-1.46.474-1.947 1.257L9 12.761V22h46v-9.24z"></path><path d="M41.613 15.931c0-1.605.994-2.93 2.227-2.931H55v18.137C55 33.26 53.68 35 52.05 35h-40.1C10.32 35 9 33.259 9 31.137V13h11.16c1.233 0 2.227 1.323 2.227 2.928v.022c0 1.605 1.005 2.901 2.237 2.901h14.752c1.232 0 2.237-1.308 2.237-2.913v-.007z" fill="#fafafa"></path></g></g></svg>',dt='<svg class="icon-search" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M684.8 223.530667a326.272 326.272 0 0 1 24.96 433.621333c2.645333 2.133333 5.290667 4.48 7.850667 7.04L870.4 817.066667c24.789333 24.746667 32.896 56.832 18.133333 71.594666-14.762667 14.805333-46.848 6.656-71.637333-18.090666l-152.789333-152.832a106.282667 106.282667 0 0 1-7.210667-7.936 326.101333 326.101333 0 0 1-433.109333-25.173334c-127.445333-127.445333-127.573333-333.952-0.256-461.269333 127.36-127.36 333.866667-127.232 461.269333 0.213333zM275.328 275.114667a252.885333 252.885333 0 0 0 0.256 357.632 252.885333 252.885333 0 0 0 357.632 0.256 252.885333 252.885333 0 0 0-0.256-357.632 252.885333 252.885333 0 0 0-357.632-0.256z" fill="#9B9B9B"></path></svg>',j='<div class="ant-spin ant-spin-spinning" aria-live="polite" aria-busy="true"><span class="ant-spin-dot ant-spin-dot-spin"><i class="ant-spin-dot-item"></i><i class="ant-spin-dot-item"></i><i class="ant-spin-dot-item"></i><i class="ant-spin-dot-item"></i></span></div>',pt='<svg class="match-empty-svg" viewBox="0 0 64 41" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0 1)" fill="none" fill-rule="evenodd"><ellipse fill="#f5f5f5" cx="32" cy="33" rx="32" ry="7"></ellipse><g fill-rule="nonzero" stroke="#d9d9d9"><path d="M55 12.76L44.854 1.258C44.367.474 43.656 0 42.907 0H21.093c-.749 0-1.46.474-1.947 1.257L9 12.761V22h46v-9.24z"></path><path d="M41.613 15.931c0-1.605.994-2.93 2.227-2.931H55v18.137C55 33.26 53.68 35 52.05 35h-40.1C10.32 35 9 33.259 9 31.137V13h11.16c1.233 0 2.227 1.323 2.227 2.928v.022c0 1.605 1.005 2.901 2.237 2.901h14.752c1.232 0 2.237-1.308 2.237-2.913v-.007z" fill="#fafafa"></path></g></g></svg>',gt='<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M9.218 17.41 19.83 6.796a.99.99 0 1 1 1.389 1.415c-3.545 3.425-4.251 4.105-11.419 11.074a.997.997 0 0 1-1.375.018c-1.924-1.801-3.709-3.568-5.573-5.43a.999.999 0 0 1 1.414-1.413z"></path></svg>',B='<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="m20.23 8.653-7.795 9.685a1.2 1.2 0 0 1-1.87 0L2.771 8.652C2.14 7.867 2.698 6.7 3.706 6.7h15.588c1.008 0 1.567 1.167.935 1.952"></path></svg>',ut='<svg focusable="false" data-icon="close-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true" fill-rule="evenodd" viewBox="64 64 896 896"><path d="M512 64c247.4 0 448 200.6 448 448S759.4 960 512 960 64 759.4 64 512 264.6 64 512 64zm127.98 274.82h-.04l-.08.06L512 466.75 384.14 338.88c-.04-.05-.06-.06-.08-.06a.12.12 0 00-.07 0c-.03 0-.05.01-.09.05l-45.02 45.02a.2.2 0 00-.05.09.12.12 0 000 .07v.02a.27.27 0 00.06.06L466.75 512 338.88 639.86c-.05.04-.06.06-.06.08a.12.12 0 000 .07c0 .03.01.05.05.09l45.02 45.02a.2.2 0 00.09.05.12.12 0 00.07 0c.02 0 .04-.01.08-.05L512 557.25l127.86 127.87c.04.04.06.05.08.05a.12.12 0 00.07 0c.03 0 .05-.01.09-.05l45.02-45.02a.2.2 0 00.05-.09.12.12 0 000-.07v-.02a.27.27 0 00-.05-.06L557.25 512l127.87-127.86c.04-.04.05-.06.05-.08a.12.12 0 000-.07c0-.03-.01-.05-.05-.09l-45.02-45.02a.2.2 0 00-.09-.05.12.12 0 00-.07 0z"></path></svg>';class mt{constructor(t){C(this,"target");C(this,"richText",document.createElement("div"));C(this,"placeholderElm",document.createElement("div"));C(this,"tipElm",null);C(this,"isExternalCallPopup",!1);C(this,"isPointSearchMode",!1);C(this,"checkboxRows",[]);C(this,"customTags",{});C(this,"selectTags",{});C(this,"rects",{});C(this,"pcElms",{containerDialogElm:null,pointDialogElm:null,pointDialogCheckElm:null,pointDialogMainElm:null,pointDialogUsersElm:[],pointDialogActiveElm:null,pointDialogLoadingElm:null,pointDialogEmptyElm:null,checkDialogElm:null,checkDialogSearchResultElm:null,checkDialogUsersElm:null,checkDialogSearchInputElm:null,checkDialogTagsElm:null,customTagDialogElms:{},customTagDialogTagKey:"",customTagDialogActiveElm:null,selectDialogElms:{},selectDialogKey:"",selectDialogAim:null,tipPopoverElm:null});C(this,"h5Elms",{dialogElm:null,dialogMainElm:null,dialogCheckElm:null,dialogShowElm:null,dialogSearchElm:null,dialogEmptyElm:null,dialogLoadingElm:null});this.target=t,this.createRichText(),this.createPlaceholder(),t.deviceInfo.isPc?this.createPCDialog():this.createH5Dialog()}createRichText(){const{options:t,deviceInfo:e}=this.target,{elm:i}=t;T(i,`chat-area-${e.isPc?"pc":"h5"}`,!0),T(this.richText,"chat-rich-text",!0),this.richText.setAttribute(E,tt),this.richText.setAttribute("contenteditable","true"),i.appendChild(this.richText)}createPlaceholder(){const{options:t}=this.target,{elm:e}=t;T(this.placeholderElm,"chat-placeholder-wrap",!0),f(this.placeholderElm,!0),e.appendChild(this.placeholderElm),this.rects.plaRect=this.placeholderElm.getBoundingClientRect()}createPCDialog(){const{options:t}=this.target,{needDialog:e,elm:i,asyncMatch:s}=t;if(!e)return;const{pcElms:n}=this;if(n.containerDialogElm=document.createElement("div"),T(this.pcElms.containerDialogElm,"chat-dialog",!0),i.parentElement)i.nextElementSibling?i.parentElement.insertBefore(n.containerDialogElm,i.nextElementSibling):i.parentElement.appendChild(n.containerDialogElm);else throw new Error('配置项："elm" 需要存在一个父级元素，请检查后重新配置！');s||this.createPCCheckDialog(),this.createPCPointDialog()}createPCCheckDialog(){const{options:t}=this.target,e=this.target.options.dialogLabels.pcPCheckDialog,{pcElms:i}=this;i.checkDialogElm=document.createElement("div"),T(i.checkDialogElm,"checkbox-dialog",!0),f(i.checkDialogElm),i.checkDialogElm.innerHTML=`
          <div class="checkbox-dialog-container">
            <div class="checkbox-dialog-container-header">
                <span>${e.title}</span>
                <span class="checkbox-dialog-container-header-close">⛌</span>
            </div>
            <div class="checkbox-dialog-container-body">
                <div class="checkbox-dialog-left-box">
                    <div class="checkbox-dialog-search">
                        <input class="checkbox-dialog-search-input" placeholder="${e.searchPlaceholder}" type="text">
                        <div class="checkbox-dialog-search-group"></div>
                    </div>
                    <div class="checkbox-dialog-tags"></div>
                    <div class="checkbox-dialog-option">
                        <button class="checkbox-dialog-option-btn btn-submit disabled">${e.confirmLabel}</button>
                        <button class="checkbox-dialog-option-btn btn-close">${e.cancelLabel}</button>
                    </div>
                </div>
                <div class="checkbox-dialog-right-box">
                    <div class="checkbox-dialog-right-box-title">${e.userTagTitle}</div>
                    <div class="checkbox-dialog-check-group"></div>
                </div>
            </div>
          </div>
        `,i.containerDialogElm.appendChild(i.checkDialogElm),i.checkDialogUsersElm=i.checkDialogElm.querySelector(".checkbox-dialog-check-group"),i.checkDialogSearchResultElm=i.checkDialogElm.querySelector(".checkbox-dialog-search-group"),i.checkDialogSearchInputElm=i.checkDialogElm.querySelector(".checkbox-dialog-search-input"),i.checkDialogTagsElm=i.checkDialogElm.querySelector(".checkbox-dialog-tags");const s=()=>{f(i.checkDialogElm),T(document.body,"disable-scroll")};i.checkDialogElm.querySelector(".checkbox-dialog-container-header-close").onclick=s,i.checkDialogElm.querySelector(".btn-close").onclick=s;const n=i.checkDialogElm.querySelector(".btn-submit");n.onclick=async()=>{if(n.classList.contains("disabled"))return;const l=this.checkboxRows.map(o=>{const r=Object.create(null);return r[t.userProps.id]=o.id,r[t.userProps.name]=o.name,r});await this.target.batchSetTag(l),s()},f(i.checkDialogSearchResultElm),i.checkDialogSearchResultElm.onclick=l=>{l.stopPropagation()},i.checkDialogSearchInputElm.onclick=l=>{l.stopPropagation()};const a=Y(l=>{const o=String(l.target.value||"").replace(/'/g,"").trim();if(!o){f(i.checkDialogSearchResultElm);return}const r=this.target.searchUserList(o).map(h=>h.id);Array.from(i.checkDialogSearchResultElm.children,(h,c)=>{if(c===i.checkDialogSearchResultElm.children.length-1)f(h,r.length===0);else{const d=h.getAttribute("data-set-id");f(h,r.indexOf(d)!==-1,"flex")}}),f(i.checkDialogSearchResultElm,!0)},200);i.checkDialogSearchInputElm.oninput=a,i.checkDialogSearchInputElm.onfocus=a}createPCPointDialog(){const{pcElms:t,target:e}=this;t.pointDialogElm=document.createElement("div"),T(t.pointDialogElm,"call-user-dialog",!0),f(t.pointDialogElm);const i=document.createElement("div");T(i,"call-user-dialog-header",!0),i.innerHTML=`<span class="call-user-dialog-header-title">${e.options.dialogLabels.pcPointDialog.title}</span>`,t.pointDialogCheckElm=document.createElement("span"),T(t.pointDialogCheckElm,"call-user-dialog-header-check",!0),t.pointDialogCheckElm.innerText=e.options.dialogLabels.pcPointDialog.checkLabel,t.pointDialogCheckElm.onclick=()=>{this.target.showPCCheckDialog(),this.isExternalCallPopup=!1},i.appendChild(t.pointDialogCheckElm),t.pointDialogElm.appendChild(i),t.pointDialogMainElm=document.createElement("div"),T(t.pointDialogMainElm,"call-user-dialog-main",!0),t.pointDialogElm.appendChild(t.pointDialogMainElm),e.options.asyncMatch&&(t.pointDialogLoadingElm=document.createElement("div"),T(t.pointDialogLoadingElm,"call-user-dialog-loading",!0),t.pointDialogLoadingElm.innerHTML=j,t.pointDialogElm.appendChild(t.pointDialogLoadingElm),f(t.pointDialogLoadingElm),t.pointDialogEmptyElm=document.createElement("div"),T(t.pointDialogEmptyElm,"call-user-dialog-empty",!0),t.pointDialogEmptyElm.innerHTML=`
                ${pt}
                <span class="empty-label">${e.options.dialogLabels.pcPointDialog.emptyLabel}</span>
            `,t.pointDialogElm.appendChild(t.pointDialogEmptyElm),f(t.pointDialogEmptyElm)),t.containerDialogElm.appendChild(t.pointDialogElm)}createH5Dialog(){const{options:t,chatEvent:e}=this.target,{needDialog:i,dialogLabels:s}=t;if(!i)return;const{h5Elms:n}=this;n.dialogElm=document.createElement("div"),T(n.dialogElm,"call-user-popup",!0),n.dialogElm.innerHTML=`
          <div class="call-user-popup-main">
            <div class="call-user-popup-header">
                <span class="popup-show">${s.h5Dialog.cancelLabel}</span>
                <span class="popup-title">${s.h5Dialog.title}</span>
                <span class="popup-check">${s.h5Dialog.confirmLabel}</span>
            </div>
            <div class="call-user-popup-search">
                ${dt}
                <input class="call-user-popup-search-input"
                       placeholder="${s.h5Dialog.searchPlaceholder}"
                       type="text">
            </div>
            <div class="call-user-popup-body"></div>
          </div>
        `;const a=async()=>{n.dialogElm.className=n.dialogElm.className.replace(/ chat-view-show/g," chat-view-hidden"),n.dialogSearchElm.value="",await U(260),f(n.dialogElm),T(document.body,"disable-scroll"),t.asyncMatch&&this.target.updateUserList([]),this.target.chatInput.restCursorPos(this.target.chatInput.vnode,this.target.chatInput.cursorIndex),this.target.chatInput.viewIntoPoint()};n.dialogElm.onclick=a;const l=n.dialogElm.querySelector(".call-user-popup-main");l.onclick=o=>{o.stopPropagation()},n.dialogShowElm=n.dialogElm.querySelector(".popup-show"),n.dialogShowElm.onclick=a,n.dialogCheckElm=n.dialogElm.querySelector(".popup-check"),n.dialogCheckElm.onclick=async()=>{if(n.dialogCheckElm.classList.contains("disabled"))return;const o=n.dialogElm.querySelectorAll(".user-popup-check-item-check")||[];if(o.length===0){await a();return}if(Array.prototype.some.call(o,c=>c.getAttribute("data-set-id")==="isALL")){await this.target.onceSetTag({[t.userProps.id]:"isALL",[t.userProps.name]:t.dialogLabels.h5Dialog.callEveryLabel}),await a();return}const r=Array.from(o,c=>c.getAttribute("data-set-id")),h=t.userList.filter(c=>r.indexOf(String(c[t.userProps.id]))!==-1);await this.target.batchSetTag(h),await a()},n.dialogMainElm=n.dialogElm.querySelector(".call-user-popup-body"),n.dialogEmptyElm=document.createElement("div"),T(n.dialogEmptyElm,"call-user-popup-empty",!0),this.h5Elms.dialogEmptyElm.innerHTML=`
            ${ht}
            <span class="empty-label">${t.dialogLabels.h5Dialog.searchEmptyLabel}</span>
        `,f(n.dialogEmptyElm),l.appendChild(n.dialogEmptyElm),t.asyncMatch&&(n.dialogLoadingElm=document.createElement("div"),T(n.dialogLoadingElm,"call-user-popup-loading",!0),n.dialogLoadingElm.innerHTML=j,f(n.dialogLoadingElm),l.appendChild(n.dialogLoadingElm)),n.dialogSearchElm=n.dialogElm.querySelector(".call-user-popup-search-input"),n.dialogSearchElm.oninput=Y(o=>{const r=String(o.target.value||"").replace(/'/g,"").trim();if(t.asyncMatch){e.matchKey++;const c=e.matchKey;this.target.updateUserList([]),f(n.dialogLoadingElm,!0),f(n.dialogEmptyElm);const g=e.triggerChatEvent("atMatch",r).find(p=>p&&p instanceof Promise);g&&g.then(p=>{if(c===e.matchKey){if(f(n.dialogLoadingElm),!p||p.length<=0){f(n.dialogEmptyElm,!0,"flex");return}this.target.updateUserList(p)}});return}const h=[];Array.from(this.h5Elms.dialogMainElm.children,c=>{if(!r){f(c,!0,"flex"),h.push(c);return}const d=c.getAttribute("data-set-name")||"",g=c.getAttribute("data-set-pinyin")||"";W(d,g,r)?(f(c,!0,"flex"),h.push(c)):f(c)}),f(this.h5Elms.dialogEmptyElm,!h.length,"flex")},200),f(n.dialogElm),document.body.appendChild(n.dialogElm)}updatePCUser(){const{pcElms:t,target:e}=this;t.pointDialogMainElm.innerHTML="",t.pointDialogActiveElm=void 0;const i=document.createDocumentFragment();if(this.target.options.needCallEvery){const l=document.createElement("div");T(l,"call-user-dialog-item",!0),l.setAttribute("data-set-id","isALL"),this.userSelectStyleAndEvent(l,{id:"isALL",name:e.options.dialogLabels.pcPointDialog.callEveryLabel}),l.innerHTML=`
                <span class="call-user-dialog-item-sculpture">
                  <span style="transform: scale(0.75)">@</span>
                </span>
                <span class="call-user-dialog-item-name">${e.options.dialogLabels.pcPointDialog.callEveryLabel}(${e.options.reformList.length})</span>
            `,i.appendChild(l)}if(e.options.reformList.forEach(l=>{const o=document.createElement("div");T(o,"call-user-dialog-item",!0),o.setAttribute("data-set-id",l.id),this.userSelectStyleAndEvent(o,l),this.getUserHtmlTemplate(o,l),i.appendChild(o)}),t.pointDialogMainElm.appendChild(i),t.pointDialogUsersElm=[],Array.from(t.pointDialogMainElm.children||[],(l,o)=>{t.pointDialogUsersElm.push({index:o,elm:l})}),e.options.asyncMatch)return;t.checkDialogUsersElm.innerHTML=`
            <div class="checkbox-dialog-check-item" data-set-value="ALL">
                <input type="checkbox" value>
                <span class="checkbox-dialog-check-item-inner"></span>
                <div class="checkbox-dialog-check-item-label">${e.options.dialogLabels.pcPCheckDialog.checkAllLabel}</div>
            </div>
        `;const s=document.createDocumentFragment();e.options.reformList.forEach(l=>{const o=document.createElement("div");T(o,"checkbox-dialog-check-item",!0),o.setAttribute("data-set-value",l.id),o.innerHTML=`
                <input type="checkbox" value>
                <span class="checkbox-dialog-check-item-inner"></span>
            `,this.getUserHtmlTemplate(o,l),s.appendChild(o)}),t.checkDialogUsersElm.appendChild(s),t.checkDialogUsersElm&&t.checkDialogUsersElm.children.length&&Array.from(t.checkDialogUsersElm.children,l=>{l.onclick=()=>{const o=l.getAttribute("data-set-value")||"",r=e.options.reformList.find(c=>c.id===o),h=l.className.indexOf("checkbox-dialog-check-item-check")===-1;o==="ALL"?this.checkboxRows=h?e.options.reformList.map(c=>c):[]:h?this.checkboxRows.push(r):this.checkboxRows=this.checkboxRows.filter(c=>c.id!==o),this.updateCheckDialogTags()}});const n=document.createDocumentFragment();e.options.reformList.forEach(l=>{const o=document.createElement("div");T(o,"checkbox-dialog-check-item",!0),o.setAttribute("data-set-id",l.id);const r=document.createElement("div");T(r,"checkbox-dialog-check-item-label",!0),this.getUserHtmlTemplate(r,l),o.appendChild(r),o.onclick=()=>{f(this.pcElms.checkDialogSearchResultElm);const h=o.getAttribute("data-set-id")||"";if(this.pcElms.checkDialogSearchInputElm.value="",this.pcElms.checkDialogSearchInputElm.focus(),this.checkboxRows.some(d=>d.id===h))return;const c=e.options.reformList.find(d=>d.id===h);c&&this.checkboxRows.push(c),this.updateCheckDialogTags()},n.appendChild(o)});const a=document.createElement("div");T(a,"checkbox-dialog-search-empty",!0),a.innerText=e.options.dialogLabels.pcPCheckDialog.searchEmptyLabel,n.appendChild(a),t.checkDialogSearchResultElm.appendChild(n)}updateH5User(){const{h5Elms:t,target:e}=this;t.dialogMainElm.innerHTML="";const i=e.options.reformList&&e.options.reformList.length>0,s=document.createDocumentFragment(),n=document.createElement("span");if(n.innerHTML=`
            <input type="checkbox" value>
            <span class="user-popup-check-item-inner"></span>
        `,i){const a=document.createElement("div");e.options.needCallEvery&&(T(a,"call-user-popup-item",!0),a.setAttribute("data-set-id","isALL"),a.innerHTML=`
                    <span class="call-user-dialog-item-sculpture">
                        <span style="transform: scale(0.75)">@</span>
                    </span>
                    <span class="call-user-dialog-item-name">${e.options.dialogLabels.h5Dialog.callEveryLabel}(${e.options.reformList.length})</span>
                `,a.appendChild(n.cloneNode(!0)),a.onclick=()=>{const l=!a.classList.contains("user-popup-check-item-check");Array.from(this.h5Elms.dialogMainElm.children,o=>{T(o,"user-popup-check-item-check",l)}),T(this.h5Elms.dialogCheckElm,"disabled",!l)},s.appendChild(a)),e.options.reformList.forEach((l,o)=>{const r=document.createElement("div");T(r,"call-user-popup-item",!0),r.setAttribute("data-set-id",l.id),r.setAttribute("data-set-name",l.name),r.setAttribute("data-set-pinyin",l.pinyin||""),this.getUserHtmlTemplate(r,l),r.appendChild(n.cloneNode(!0)),s.appendChild(r),r.onclick=h=>{const c=!r.classList.contains("user-popup-check-item-check");T(r,"user-popup-check-item-check",c);const d=Array.prototype.every.call(this.h5Elms.dialogMainElm.children,p=>p.classList.contains("user-popup-check-item-check")||p.getAttribute("data-set-id")==="isALL");T(a,"user-popup-check-item-check",d);const g=Array.prototype.some.call(this.h5Elms.dialogMainElm.children,p=>p.classList.contains("user-popup-check-item-check"));T(this.h5Elms.dialogCheckElm,"disabled",!g)}})}t.dialogMainElm.appendChild(s)}updateCheckDialogTags(){const t=this.checkboxRows.map(o=>o.id),e=[],i=[],s=document.createElement("div");s.className="check-empty",s.innerHTML=`
            ${ct}
            <span class="check-empty-label">${this.target.options.dialogLabels.pcPCheckDialog.checkEmptyLabel}</span>
        `,Array.from(this.pcElms.checkDialogTagsElm.children,o=>{const r=o.getAttribute("data-set-value");t.indexOf(r)===-1?i.push(o):e.push(r)}),Array.from(this.pcElms.checkDialogUsersElm.children,(o,r)=>{if(r===0){T(o,"checkbox-dialog-check-item-check",t.length===this.target.options.reformList.length);return}const h=o.getAttribute("data-set-value");T(o,"checkbox-dialog-check-item-check",t.indexOf(h)!==-1)}),i.forEach(o=>{this.pcElms.checkDialogTagsElm.removeChild(o)});const n=this.pcElms.checkDialogElm.querySelector(".btn-submit");T(n,"disabled",t.length<=0),t.length||this.pcElms.checkDialogTagsElm.appendChild(s);const a=this.checkboxRows.filter(o=>e.indexOf(o.id)===-1);if(!a.length)return;const l=document.createDocumentFragment();a.forEach(o=>{const r=document.createElement("div");r.setAttribute("class","checkbox-dialog-tag-item"),r.setAttribute("data-set-value",o.id),r.innerHTML=`
        <span>${o.name}</span>
      `;const h=document.createElement("span");h.setAttribute("class","checkbox-dialog-tag-item-close"),h.innerHTML="⛌",h.onclick=()=>{const c=r.getAttribute("data-set-value");this.checkboxRows=this.checkboxRows.filter(d=>d.id!==c),this.updateCheckDialogTags()},r.appendChild(h),l.appendChild(r)}),this.pcElms.checkDialogTagsElm.appendChild(l)}userSelectStyleAndEvent(t,e){t.addEventListener("click",async i=>{const{options:s}=this.target;if(i.stopPropagation(),this.updatePointActiveUserElm(t),this.isPointSearchMode||s.asyncMatch)await this.target.matchSetTag(e);else{const n=s.userList.find(a=>String(a[s.userProps.id])===e.id);await this.target.onceSetTag(n)}this.exitPointDialog()})}bindCustomTrigger(){Object.values(this.pcElms.customTagDialogElms).forEach(e=>{this.pcElms.containerDialogElm.removeChild(e)}),this.pcElms.customTagDialogElms={},this.customTags={},this.target.options.customTrigger.forEach(e=>{e.tagList&&e.tagList.length>0&&(this.customTags[e.prefix]=e.tagList.map(i=>({id:String(i.id),name:String(i.name),pinyin:String(i.pinyin||"")})),this.createCustomTagDialog(e))})}createCustomTagDialog(t){const e=document.createElement("div");e.setAttribute("class","call-tag-dialog"),f(e);const i=document.createElement("div");i.setAttribute("class","call-tag-dialog-header"),i.innerHTML=`<span class="call-tag-dialog-header-title">${t.dialogTitle||t.prefix}</span>`,e.appendChild(i);const s=document.createElement("div");s.setAttribute("class","call-tag-dialog-main"),t.tagList.forEach(n=>{const a=document.createElement("div");a.setAttribute("class","call-tag-dialog-item"),a.setAttribute("data-set-id",n.id);const l=document.createElement("span");l.setAttribute("class","call-tag-dialog-item-name"),l.innerHTML=n.name,a.appendChild(l),a.addEventListener("click",async o=>{o.stopPropagation(),this.updateActiveCustomTagElm(a),this.isPointSearchMode?await this.target.matchSetCustomTag(n):await this.target.onceSetCustomTag(n),this.exitCustomTagDialog()}),s.appendChild(a)}),e.appendChild(s),this.pcElms.containerDialogElm.appendChild(e),this.pcElms.customTagDialogElms[t.prefix]=e}getUserHtmlTemplate(t,e){const i=document.createElement("span");if(i.setAttribute("class",`call-user-dialog-item-sculpture ${e.avatar?"is-avatar":""}`),e.avatar){const n=new Image;n.alt="",n.src=String(e.avatar),i.appendChild(n)}else i.innerHTML=`<span style="transform: scale(0.75)">${e.name.slice(-2)}</span>`;t.appendChild(i);const s=document.createElement("span");s.setAttribute("class","call-user-dialog-item-name"),s.innerHTML=e.name,t.appendChild(s)}updatePointActiveUserElm(t,e=!1){if(this.pcElms.pointDialogActiveElm&&T(this.pcElms.pointDialogActiveElm,"call-user-dialog-item-active"),this.pcElms.pointDialogActiveElm=t,t&&(T(t,"call-user-dialog-item-active",!0),e)){const i=Array.prototype.filter.call(this.pcElms.pointDialogMainElm.children,o=>o.className.indexOf("user-no-match")===-1),s=t.clientHeight,n=Array.prototype.indexOf.call(i,t),a=Math.ceil(Math.floor(this.pcElms.pointDialogMainElm.clientHeight/s)/2),l=n+1-a;l>0?this.pcElms.pointDialogMainElm.scrollTop=l*s:this.pcElms.pointDialogMainElm.scrollTop=0}}updateActiveCustomTagElm(t,e=!1){if(this.pcElms.customTagDialogActiveElm&&T(this.pcElms.customTagDialogActiveElm,"call-tag-dialog-item-active"),this.pcElms.customTagDialogActiveElm=t,t&&(T(t,"call-tag-dialog-item-active",!0),e)){const i=this.pcElms.customTagDialogElms[this.pcElms.customTagDialogTagKey].children[1],s=Array.prototype.filter.call(i.children,r=>r.className.indexOf("tag-no-match")===-1),n=t.clientHeight,a=Array.prototype.indexOf.call(s,t),l=Math.ceil(Math.floor(i.clientHeight/n)/2),o=a+1-l;o>0?i.scrollTop=o*n:i.scrollTop=0}}showPointDialog(t){this.exitSelectDialog(),this.exitCustomTagDialog(),this.exitPointDialog(),this.isPointSearchMode=!!t;let e=null;this.pcElms.pointDialogUsersElm.forEach(i=>{const s=i.elm,n=s.getAttribute("data-set-id"),a=t&&t.every(l=>l.id!==n);!e&&!a&&(e=s),T(s,"user-no-match",a)}),e!==null&&this.updatePointActiveUserElm(e),f(this.pcElms.pointDialogCheckElm,!this.target.options.asyncMatch&&!this.isPointSearchMode),f(this.pcElms.pointDialogElm,!0),this.target.chatEvent.debounceEvents.dialogMoveToRange(this.pcElms.pointDialogElm),this.pcElms.pointDialogMainElm.scrollTop=0}showCustomTagDialog(t,e){this.exitSelectDialog(),this.exitCustomTagDialog(),this.exitPointDialog(),this.isPointSearchMode=!!e,this.pcElms.customTagDialogTagKey=t;const i=this.pcElms.customTagDialogElms[t],s=i.children[1];let n=null;Array.from(s.children,a=>{const l=a.getAttribute("data-set-id"),o=e&&e.every(r=>r.id!==l);!n&&!o&&(n=a),T(a,"tag-no-match",o)}),n!==null&&this.updateActiveCustomTagElm(n),f(i,!0),this.target.chatEvent.debounceEvents.dialogMoveToRange(i),i.children[1].scrollTop=0}exitPointDialog(){this.updatePointActiveUserElm(),this.target.options.asyncMatch&&this.target.updateUserList([]),f(this.pcElms.pointDialogElm)}exitCustomTagDialog(){this.updateActiveCustomTagElm();for(const t in this.pcElms.customTagDialogElms)f(this.pcElms.customTagDialogElms[t])}ruleShowPointDialog(){const{options:t,chatInput:e}=this.target;t.needDialog&&t.reformList.length>0&&e.showAt()&&(this.isExternalCallPopup=!1,this.showPointDialog())}showPlaceholder(){f(this.placeholderElm,this.target.isEmpty()),this.offsetTipElm()}bindSelectList(){Object.values(this.pcElms.selectDialogElms).forEach(e=>{this.pcElms.containerDialogElm.removeChild(e)}),this.pcElms.selectDialogElms={},this.selectTags={},this.target.options.selectList.forEach(e=>{e.options&&e.options.length>0&&(this.selectTags[e.key]=e.options.map(i=>({id:String(i.id),name:String(i.name),preview:String(i.preview||"")})),this.createSelectDialog(e))})}createSelectDialog(t){const e=document.createElement("div");e.setAttribute("class","chat-select-dialog"),f(e);const i=document.createElement("div");i.setAttribute("class","chat-select-dialog-header"),i.innerHTML=`<span class="chat-select-dialog-header-title">${t.dialogTitle||t.key}</span>`,e.appendChild(i);const s=document.createElement("div");s.setAttribute("class","chat-select-dialog-main"),t.options.forEach(a=>{const l=document.createElement("div");if(l.setAttribute("class","chat-select-dialog-item"),l.setAttribute("data-set-id",a.id),a.preview){const h=document.createElement("img");h.setAttribute("class","chat-select-dialog-preview"),h.src=String(a.preview),l.appendChild(h)}const o=document.createElement("span");o.setAttribute("class","chat-select-dialog-name"),o.textContent=a.name;const r=document.createElement("span");r.setAttribute("class","chat-select-dialog-check"),r.innerHTML=gt,f(r),o.appendChild(r),l.appendChild(o),l.onclick=async()=>{await this.target.setSelectTag(a)},s.appendChild(l)}),e.appendChild(s);const n=document.createElement("div");n.setAttribute("class","chat-select-arrow"),e.appendChild(n),this.pcElms.containerDialogElm.appendChild(e),this.pcElms.selectDialogElms[t.key]=e}exitSelectDialog(){for(const t in this.pcElms.selectDialogElms)f(this.pcElms.selectDialogElms[t]);this.pcElms.selectDialogKey="",this.pcElms.selectDialogAim&&(T(this.pcElms.selectDialogAim,"aim"),this.pcElms.selectDialogAim=null)}createTipElm(t){this.tipElm||(this.tipElm=document.createElement("div")),T(this.tipElm,"chat-tip-wrap",!0),this.tipElm.innerHTML=`
            <div class="chat-tip-tag">
                <span class="chat-tip-tag-txt">${t.tagLabel||"--"}</span>
                <span class="chat-tip-tag-close">
                    ${ut}
                </span>
            </div>
        `,this.target.options.elm.appendChild(this.tipElm);const e=this.tipElm.children[0],i=(e.clientHeight-this.target.chatInput.NODE_HEIGHT)/2;this.tipElm.style.top=`-${i}px`,e.onclick=()=>{this.target.closeTipTag()},e.onmouseenter=()=>{if(this.pcElms.tipPopoverElm){f(this.pcElms.tipPopoverElm,!0);const l=this.pcElms.containerDialogElm.getBoundingClientRect();this.rects.tipRect=this.tipElm.getBoundingClientRect();const o=(this.pcElms.tipPopoverElm.clientWidth-(this.tipElm.clientWidth+(this.tipElm.clientWidth-e.clientWidth)))/2;this.pcElms.tipPopoverElm.style.left=-o+"px",this.pcElms.tipPopoverElm.style.bottom=l.y-this.rects.tipRect.y+"px",this.pcElms.tipPopoverElm.style.transform=e.style.transform}},e.onmouseleave=()=>{this.pcElms.tipPopoverElm&&f(this.pcElms.tipPopoverElm)};const n=this.richText.children[0].children[0];this.rects.tipRect=this.tipElm.getBoundingClientRect();const a=this.rects.tipRect;this.placeholderElm.style.paddingLeft=a.width+"px",n.style.paddingLeft=a.width-n.offsetLeft+"px",this.offsetTipElm(),this.target.deviceInfo.isPc&&(this.pcElms.tipPopoverElm||(this.pcElms.tipPopoverElm=document.createElement("div")),T(this.pcElms.tipPopoverElm,"chat-tip-popover",!0),this.pcElms.tipPopoverElm.innerHTML=`
                <div class="chat-tip-popover-main">
                    <span class="chat-tip-popover-txt">${t.popoverLabel||"--"}</span>
                    <span class="chat-tip-popover-code ${t.codeLabel?"":"chat-view-show"}">${t.codeLabel||"--"}</span>
                </div>
                <div class="chat-tip-popover-arrow"></div>
            `,this.pcElms.containerDialogElm.appendChild(this.pcElms.tipPopoverElm),f(this.pcElms.tipPopoverElm))}offsetTipElm(){if(this.tipElm){const t=this.richText.children[0].children[0];t.style.paddingLeft=this.rects.tipRect.width-t.offsetLeft+"px",this.target.nextTick(()=>{if(this.tipElm){const e=this.tipElm.children[0],i=this.richText.children[0].children[0];e.style.transform=`translateY(${i.offsetTop-this.target.chatInput.NODE_PADDING_DIFF}px)`}})}}removeTipElm(){this.tipElm&&(this.target.options.elm.removeChild(this.tipElm),this.tipElm=null),this.pcElms.tipPopoverElm&&(this.pcElms.containerDialogElm.removeChild(this.pcElms.tipPopoverElm),this.pcElms.tipPopoverElm=null);const e=this.richText.children[0].children[0];this.placeholderElm.style.removeProperty("padding-left"),e.style.removeProperty("padding-left"),this.target.chatInput.setRangeLastText()}}class Et{constructor(t){C(this,"target");C(this,"richText");C(this,"vnode");C(this,"cursorIndex");C(this,"cursorLeft");C(this,"needCallSpace",!1);C(this,"VOID_KEY","\uFEFF");C(this,"ZERO_WIDTH_KEY","​");C(this,"INPUT_TAG_WRAP_KEY",`​
​`);C(this,"NODE_HEIGHT",24);C(this,"NODE_PADDING_DIFF",10);C(this,"IME_RECORD",{MARK:void 0,GRID:void 0,TAG:void 0,NODE:void 0,INDEX:void 0});this.target=t,this.richText=t.chatElement.richText,this.initEditor()}initEditor(t=!1,e){if(t||this.getNodeEmpty(this.richText)){this.richText.innerHTML="";const i=this.getGridElm();this.richText.appendChild(i);const s=i.children[0].children[0];e&&(s.textContent=e,s.setAttribute(I,"false"));const n=s.childNodes[0];t||this.target.options.autoFocus?this.restCursorPos(n,n.textContent===this.VOID_KEY?1:n.textContent.length):(this.vnode=n,this.cursorIndex=n.textContent===this.VOID_KEY?1:n.textContent.length),this.target.nextTick(()=>{const a=i.getBoundingClientRect();this.NODE_HEIGHT=a.height,this.NODE_PADDING_DIFF=a.top-this.target.options.elm.getBoundingClientRect().top})}}onceCall(t){return new Promise(e=>{const i=this.createChatTagElm(t,"@","at-user","user-id");this.replaceRegContent(i),e()})}onceSearchCall(t,e){return new Promise(i=>{const s=this.createChatTagElm(t,"@","at-user","user-id");this.replaceRegContent(s,e),i()})}onceCustomCall(t,e,i){return new Promise(s=>{const n=this.createChatTagElm(t,i,"at-tag","tag-id");n.children[0].setAttribute("data-set-prefix",i),this.replaceRegContent(n,e),s()})}upDataNodeOrIndex(){var a,l,o;const{focusNode:t,focusOffset:e,anchorOffset:i}=window.getSelection(),s=(t==null?void 0:t.parentNode)||void 0;!s||!s.getAttribute||s.getAttribute(E)!==_||((o=(l=(a=t==null?void 0:t.parentNode)==null?void 0:a.parentNode)==null?void 0:l.parentNode)==null?void 0:o.parentNode)!==this.richText||(this.vnode=t,this.cursorIndex=e,this.cursorLeft=i<e?i:e)}showAt(){if(this.upDataNodeOrIndex(),!this.vnode||this.vnode.nodeType!==Node.TEXT_NODE)return!1;const t=this.vnode.textContent||"",e=/@([^@\s]*)$/,i=t.slice(0,this.cursorIndex),s=e.exec(i);return s&&s.length===2&&i[i.length-1]==="@"}getRangeRect(){let t=0,e=0;const i=window.getSelection();if(i.focusNode.nodeType!==Node.TEXT_NODE)return null;const s=i.getRangeAt(0).getClientRects()[0];return s&&(t=s.x,e=s.y),{x:t,y:e}}createChatTagElm(t,e,i,s){const n=document.createElement("span");return n.className=i,n.setAttribute(`data-${s}`,String(t.id)),n.textContent=`${e}${t.name}${this.needCallSpace?" ":""}`,this.createNewDom(n)}createNewDom(t){const e=document.createElement("span");return e.className="chat-tag",e.setAttribute("contenteditable","false"),e.setAttribute(E,M),e.appendChild(t),e}restCursorPos(t,e){e==null?e=t.textContent===this.VOID_KEY?1:0:e>t.textContent.length&&(e=t.textContent.length);const i=new Range;i.setStart(t,e),i.setEnd(t,e);const s=window.getSelection();s&&(this.vnode=t,this.cursorIndex=e,this.cursorLeft=e,s.removeAllRanges(),s.addRange(i))}replaceRegContent(t,e=!0){const i=this.vnode.textContent;let s;typeof e=="boolean"?s=i.slice(0,e?this.cursorIndex-1:this.cursorIndex):s=i.slice(0,e-1),s.length===0?(this.vnode.parentElement.setAttribute(I,"true"),this.vnode.textContent=this.VOID_KEY):this.vnode.textContent=s;let n=i.slice(this.cursorIndex);const a=this.vnode.parentNode.parentNode,l=a.nextSibling;l?a.parentNode.insertBefore(t,l):a.parentNode.appendChild(t);const r=t.previousSibling.childNodes[0],h=r.childNodes[1];h&&r.removeChild(h);const c=this.getGridElm(!0),d=c.childNodes[0];n&&n!==this.VOID_KEY&&(d.setAttribute(I,"false"),d.innerHTML=n);const g=d.childNodes[1];t.nextSibling?(g&&d.removeChild(g),a.parentNode.insertBefore(c,t.nextSibling)):a.parentNode.appendChild(c),this.restCursorPos(d.childNodes[0])}batchReplaceRegContent(t=[],e=!0){return new Promise(i=>{let s=`<span ${E}="${b}"><span class="chat-grid-input" ${E}="${_}" ${I}="true">${this.VOID_KEY}</span></span>`;t.forEach(a=>{s+=`<span class="chat-tag" contenteditable="false" ${E}="${M}"><span class="at-user" data-user-id="${a.id}" contentEditable="false">@${a.name}${this.needCallSpace?" ":""}</span></span><span ${E}="${b}"><span class="chat-grid-input" ${E}="${_}" ${I}="true">${this.VOID_KEY}</span></span>`});const n=document.createElement("div");n.innerHTML=s,this.insetRangeGrid(n,e?1:0),i()})}switchRange(t){var l,o;let{focusNode:e,focusOffset:i}=window.getSelection();e.getAttribute&&e.getAttribute(E)===_&&(e=e.childNodes[0]);let s,n,a=!1;if(e.nodeType===Node.TEXT_NODE){const r=e.textContent.length,h=e.parentNode.parentNode;switch(t){case"ArrowLeft":if(i>0&&e.textContent!==this.VOID_KEY){n=i-1,s=e;break}const c=h.previousSibling;if(c&&c.children[0].classList.contains("at-input")){s=c.children[0].children[0].childNodes[0],n=s.textContent===this.VOID_KEY?1:s.textContent.length,a=!0;break}const d=(l=h==null?void 0:h.previousSibling)==null?void 0:l.previousSibling;if(d)s=d.childNodes[0].childNodes[0],n=s.textContent.length;else{const m=h.parentNode.previousSibling;m&&(s=m.lastChild.childNodes[0].childNodes[0],n=s.textContent.length)}break;case"ArrowRight":if(i<r&&e.textContent!==this.VOID_KEY){n=i+1,s=e;break}const g=h.nextSibling;if(g&&g.children[0].classList.contains("at-input")){s=g.children[0].children[0].childNodes[0],n=s.textContent===this.VOID_KEY?1:0,a=!0;break}const p=(o=h==null?void 0:h.nextSibling)==null?void 0:o.nextSibling;if(p)s=p.childNodes[0].childNodes[0],n=s.textContent===this.VOID_KEY?1:0;else{const m=h.parentNode.nextSibling;m&&(s=m.childNodes[0].childNodes[0].childNodes[0],n=s.textContent===this.VOID_KEY?1:0)}break}}(n||n===0)&&(a?this.setInputTagRange(s,n):this.restCursorPos(s,n))}getGridElm(t=!1){const e=document.createElement("span");if(e.setAttribute(E,b),e.innerHTML=`<span class="chat-grid-input" ${E}="${_}" ${I}="true">${this.VOID_KEY}<br></span>`,t)return e;const i=document.createElement("p");return i.className="chat-grid-wrap",i.setAttribute(E,H),i.appendChild(e),i}updateGrid(){const t=window.getSelection(),e=t.focusNode;if(!e)return;const i=e.parentNode,s=i.getAttribute(E);let n,a,l,o;switch(s){case tt:if(n=e.childNodes[t.focusOffset],!n||n.getAttribute(E)===M){const p=this.getGridElm(!0),m=p.children[0];n?(m.removeChild(m.childNodes[1]),e.insertBefore(p,n)):e.appendChild(p),this.restCursorPos(m.childNodes[0]);break}if(n.tagName&&n.tagName.toLocaleUpperCase()==="BR"){const p=this.getGridElm(!0),m=p.children[0];e.insertBefore(p,n),e.removeChild(n),this.restCursorPos(m.childNodes[0],m.childNodes[0].textContent.length)}break;case b:const r=i.parentNode,h=Array.prototype.indexOf.call(r.childNodes,i);if(h===-1)break;if(h===0){const p=t.focusNode;p.setAttribute(I,"true"),p.innerHTML=`${this.VOID_KEY}<br>`,n=p.childNodes[0],this.restCursorPos(n,n.textContent.length);break}let c=i.previousSibling,d;c.getAttribute(E)===M?(d=c.previousSibling,r.removeChild(c),r.removeChild(i)):(d=i.previousSibling,r.removeChild(i)),n=d.childNodes[0].childNodes[0],n.textContent===this.VOID_KEY&&n.parentNode.appendChild(document.createElement("br")),this.restCursorPos(n,n.textContent.length);break;case _:if(o=i.parentNode,l=o.parentNode,this.getNodeEmpty(i)){i.setAttribute(I,"true"),l.childNodes[l.childNodes.length-1]===o&&(i.innerHTML=`${this.VOID_KEY}<br>`),n=i.childNodes[0],this.restCursorPos(n,n.textContent.length);break}if(String(i.getAttribute(I))==="true"){i.setAttribute(I,"false"),n=i.childNodes[0],this.target.chatEvent.isIMEModel?(i.childNodes[1]&&i.removeChild(i.childNodes[1]),n.textContent===this.VOID_KEY&&i.setAttribute(I,"true")):i.textContent=n.textContent.replace(new RegExp(this.VOID_KEY,"g"),"");const p=i.childNodes[0];this.restCursorPos(p,p.textContent.length)}if(a=i.parentNode.nextSibling,a&&a.nodeType===Node.TEXT_NODE){let p=a.textContent,m=this.getGridElm(!0);m.childNodes[0].textContent=p,m.childNodes[0].setAttribute(I,"false"),a.parentNode.insertBefore(m,a),a.parentNode.removeChild(a),a=m}a&&a.getAttribute(E)===b&&this.markMerge(i.parentNode,a);break}}getNodeEmpty(t){const e=new RegExp(`^(${this.ZERO_WIDTH_KEY}|<br>|${this.VOID_KEY})+$`);return!t.innerHTML||e.test(t.innerHTML)}setWrap(t=!0){const e=window.getSelection();let{focusNode:i,focusOffset:s}=e;if(i.nodeType!==Node.TEXT_NODE){if(!i.getAttribute||i.getAttribute(E)!==_)return;i=i.childNodes[0]}const n=i.textContent.slice(s),a=i.parentNode.parentNode,l=a.parentNode,o=Array.prototype.indexOf.call(l.childNodes,a),r=Array.prototype.slice.call(l.childNodes,o+1),h=this.getGridElm();let c=h.children[0].children[0].childNodes[0];(n||r.length>0)&&c.parentNode.removeChild(c.parentNode.childNodes[1]),n&&n!==this.VOID_KEY&&(i.textContent=i.textContent.slice(0,s),c.textContent=n,c.parentElement.setAttribute(I,"false")),r.forEach(p=>{l.removeChild(p),h.appendChild(p)});const d=l.lastChild.childNodes[0],g=h.lastChild.childNodes[0];if(d.childNodes.length<=1){const p=d.childNodes[0];(!p.textContent||p.textContent===this.VOID_KEY)&&(d.innerHTML=`${this.VOID_KEY}<br>`,d.setAttribute(I,"true"))}if(g.parentElement.getAttribute(E)!==b)h.appendChild(this.getGridElm(!0));else if(g.childNodes.length<=1){const p=g.childNodes[0];(!p.textContent||p.textContent===this.VOID_KEY)&&(g.innerHTML=`${this.VOID_KEY}<br>`,g.setAttribute(I,"true"),c=h.children[0].children[0].childNodes[0])}l.nextSibling?this.richText.insertBefore(h,l.nextSibling):this.richText.appendChild(h),t&&this.restCursorPos(c,c.textContent===this.VOID_KEY?1:0)}selectRegionMerge(){const t=window.getSelection();if(t.isCollapsed||t.rangeCount<=0)return;const e=t.getRangeAt(0);if(e.startContainer.nodeType===Node.TEXT_NODE&&e.startContainer===e.endContainer){const i=e.startContainer;if(i.length===e.endOffset-e.startOffset){const s=i.parentNode,n=s.parentNode===s.parentNode.parentNode.lastChild;s.setAttribute(I,"true"),s.innerHTML=`\uFEFF${n?"<br>":""}`,this.restCursorPos(s.childNodes[0])}else e.deleteContents()}else if(e.commonAncestorContainer&&e.commonAncestorContainer.getAttribute(E)===H){const i=e.startContainer.nodeType===Node.TEXT_NODE?e.startContainer.parentNode.parentNode:e.startContainer,s=e.endContainer.nodeType===Node.TEXT_NODE?e.endContainer.parentNode.parentNode:e.endContainer;e.deleteContents(),i.getAttribute(E)===s.getAttribute(E)&&this.markMerge(i,s)}else if(e.commonAncestorContainer===e.startContainer&&e.startContainer===e.endContainer)this.initEditor(!0);else{const i=a=>{if(a.nodeType===Node.TEXT_NODE)return a.parentNode.parentNode.parentNode;switch(a.getAttribute(E)){case _:return a.parentNode.parentNode;case b:return a.parentNode;case H:return a;default:return null}},s=i(e.startContainer),n=i(e.endContainer);if(!s||!n)return;e.deleteContents(),this.gridMerge(s,n)}return!0}gridElmMerge(){const t=window.getSelection(),{focusNode:e,focusOffset:i,isCollapsed:s}=t;if(!e)return this.restCursorPos(this.vnode,this.cursorIndex),!1;if(i>1||!s)return!1;const n=(o,r)=>o.parentNode!==this.richText&&o!==o.parentNode.childNodes[0]?!1:Array.prototype.indexOf.call(this.richText.childNodes,o)!==-1?o:r>=6?!1:n(o.parentNode,r+1),a=n(e,0);if(!a||a===this.richText.childNodes[0]||i===1&&a.children[0].children[0].getAttribute(I)==="false")return!1;const l=a.previousSibling;return this.gridMerge(l,a),!0}delMarkRule(){const t=window.getSelection(),e=t.focusNode;if(!e)return this.restCursorPos(this.vnode,this.cursorIndex),!1;const i=e.textContent,s=e.parentNode,n=s.parentNode,a=n.parentNode;if(!t.isCollapsed||s.getAttribute(E)!==_)return!1;if(i&&i.length===1&&n!==a.childNodes[0]&&(t.focusOffset!==0||i===this.VOID_KEY)){if(i===this.VOID_KEY){const l=n.previousSibling;if(l.children[0].classList.contains("at-input")&&l.children[0].children[0].textContent!==this.VOID_KEY)return this.rangeToInputTag(l.children[0]),!0;const o=l.previousSibling;a.removeChild(l),a.removeChild(n);const r=o.childNodes[0],h=r.childNodes[0];h.textContent===this.VOID_KEY&&o===a.lastChild&&r.appendChild(document.createElement("br")),this.restCursorPos(h,h.textContent.length)}else{s.innerHTML=n===a.lastChild?`${this.VOID_KEY}<br>`:this.VOID_KEY,s.setAttribute(I,"true");const l=s.childNodes[0];this.restCursorPos(l,1)}return!0}else if(t.focusOffset===0){const l=s.parentNode,o=l==null?void 0:l.previousSibling;return!o||o.getAttribute(E)!==M?!1:o.children[0].classList.contains("at-input")&&o.children[0].children[0].textContent!==this.VOID_KEY?(this.rangeToInputTag(o.children[0]),!0):(this.delTag(o),!0)}}delTag(t){const e=t.previousSibling,i=t.nextSibling;t.parentNode.removeChild(t),this.markMerge(e,i)}gridMerge(t,e,i=!0){t.lastChild.getAttribute(E)!==b&&t.appendChild(this.getGridElm(!0)),e.childNodes[0].getAttribute(E)!==b&&e.insertBefore(this.getGridElm(!0),e.childNodes[0]);const s=t.lastChild.childNodes[0],n=s.childNodes[0];let a=n.textContent.length;Array.from(e.childNodes,o=>{t.appendChild(o.cloneNode(!0))}),e.childNodes.length>1&&s.childNodes[1]&&s.removeChild(s.childNodes[1]);const l=s.parentNode.nextSibling;if(l){const r=l.children[0].childNodes[0];r&&r.textContent!==this.VOID_KEY&&(s.childNodes[1]&&s.removeChild(s.childNodes[1]),n.textContent=(n.textContent+r.textContent).replace(new RegExp(this.VOID_KEY,"g"),()=>(a--,"")),n.parentElement.setAttribute(I,"false")),t.removeChild(l)}n.textContent===""&&(n.textContent=this.VOID_KEY,n.parentNode.setAttribute(I,"true"),a=1),this.richText.removeChild(e),i&&this.restCursorPos(n,a)}markMerge(t,e){const s=t.children[0].childNodes[0];let n=s.textContent.length;if(e){const o=e.children[0].childNodes[0];o&&o.textContent!==this.VOID_KEY&&(s.textContent=(s.textContent+o.textContent).replace(new RegExp(this.VOID_KEY,"g"),()=>(n--,"")),s.parentElement.setAttribute(I,"false")),e.parentNode.removeChild(e)}s.textContent===""&&(s.textContent=this.VOID_KEY,s.parentNode.setAttribute(I,"true"),n=1);const a=t.parentNode;s.textContent===this.VOID_KEY&&t===a.lastChild&&(s.parentNode.appendChild(document.createElement("br")),s.parentNode.setAttribute(I,"true"),n=1),this.restCursorPos(s,n)}setCallSpace(t){this.needCallSpace=t}getWrapNode(t,e=!1){if(t.nodeType===Node.TEXT_NODE)return t.parentNode.parentNode.parentNode;const i=t.getAttribute(E);if(e&&i===M)return t.parentNode;switch(i){case _:return t.parentNode.parentNode;case b:return t.parentNode;case H:return t}}getMarkNode(t,e=!1){if(t.nodeType===Node.TEXT_NODE)return t.parentNode?t.parentNode.parentNode:null;const i=t.getAttribute(E);if(e&&i===M)return t;switch(i){case _:return t.parentNode;case b:return t}}getRichTextNodeIndex(t){const e=this.getMarkNode(t),i=e?e.parentNode:null;return!e||!i?{gridIndex:null,markIndex:null}:{gridIndex:Array.prototype.indexOf.call(this.richText.childNodes,i),markIndex:Array.prototype.indexOf.call(i.childNodes,e)}}setWrapNodeByMark(t){const e=document.createElement("p");return e.className="chat-grid-wrap",e.setAttribute(E,H),Array.from(t,i=>{e.appendChild(i)}),e}setRangeLastText(){const t=this.richText.childNodes[this.richText.childNodes.length-1],s=t.childNodes[t.childNodes.length-1].children[0].childNodes[0];this.restCursorPos(s,s.textContent===this.VOID_KEY?1:s.textContent.length),this.viewIntoPoint()}viewIntoPoint(){let t,e;const i=window.getSelection(),{focusNode:s,focusOffset:n}=i;if(s&&s.parentElement&&s.parentElement.classList.contains("input-write"))t=s.parentElement.parentElement,e=n;else{if(!this.vnode)return;t=this.getMarkNode(this.vnode),e=this.cursorIndex}if(!t)return;const a=t.getBoundingClientRect(),l=Math.ceil(a.height/this.NODE_HEIGHT),o=Math.floor(t.textContent.length/l)||1,h=(Math.floor(e/o)||1)*this.NODE_HEIGHT,c=a.top+(h-this.NODE_HEIGHT),d=this.richText.parentElement,g=d.getBoundingClientRect(),p=g.top,m=g.top+g.height;if(c<p+this.NODE_PADDING_DIFF){const y=p-c;d.scrollTo(0,d.scrollTop-y)}else if(c>m-this.NODE_HEIGHT){const y=c-m+this.NODE_HEIGHT;d.scrollTo(0,d.scrollTop+y)}}insetRangeGrid(t,e=0){const i=this.vnode.textContent,s=i.slice(0,this.cursorIndex-e);s.length===0?(this.vnode.parentElement.setAttribute(I,"true"),this.vnode.textContent=this.VOID_KEY):this.vnode.textContent=s;let n=i.slice(this.cursorIndex);const a=[],l=document.createDocumentFragment();Array.from(t.children).forEach((m,y)=>{a.push(m),y!==0&&l.appendChild(m)});const r=a[a.length-1].children[0];n&&n.length>0&&n!==this.VOID_KEY?(r.setAttribute(I,"false"),r.innerHTML=r.textContent+n):r.setAttribute(I,"true");const h=this.getMarkNode(this.vnode),c=h.parentElement,d=h.children[0],g=a[0].textContent;g&&g.length>0&&g!==this.VOID_KEY&&(d.setAttribute(I,"false"),d.innerHTML=(d.textContent+g).replace(new RegExp(this.VOID_KEY,"g"),"")),d.childNodes[1]&&d.removeChild(d.childNodes[1]),h.nextElementSibling?(r.childNodes[1]&&r.removeChild(r.childNodes[1]),c.insertBefore(l,h.nextElementSibling)):c.appendChild(l);const p=n&&n!==this.VOID_KEY?n.length:0;if(a.length>1){const m=r.childNodes[0];this.restCursorPos(m,m.textContent===this.VOID_KEY?1:m.textContent.length-p)}else{const m=d.childNodes[0];this.restCursorPos(m,m.textContent===this.VOID_KEY?1:m.textContent.length-p)}}insetRangeGrids(t){const e=document.createDocumentFragment();Array.from(t).forEach(a=>{e.appendChild(a)});const i=this.getWrapNode(this.vnode);this.restCursorPos(this.vnode,this.cursorIndex),this.setWrap(!1);const s=i.nextElementSibling;s&&this.richText.insertBefore(e,s),s&&s.previousElementSibling?(this.gridMerge(i,i.nextElementSibling,!1),this.gridMerge(s.previousElementSibling,s,!0)):this.gridMerge(i,i.nextElementSibling,!0)}getOffsetRange(t,e,i=!1){const s=e.children[0].childNodes[0],n=s.textContent;if(t===0)return{rangeNode:s,rangeIndex:i?n.length:n===this.VOID_KEY?1:0};if(n!==this.VOID_KEY&&n.length>=t)return{rangeNode:s,rangeIndex:i?n.length-t:t};let a,l;if(i?(a=!!(e.previousElementSibling&&e.previousElementSibling.previousElementSibling),l=!!e.parentElement.previousElementSibling):(a=!!(e.nextElementSibling&&e.nextElementSibling.nextElementSibling),l=!!e.parentElement.nextElementSibling),!a&&!l)return{rangeNode:s,rangeIndex:i?n.length===this.VOID_KEY?1:0:n.length===this.VOID_KEY?1:n.length};const o=t-n.length,r=i?a?e.previousElementSibling.previousElementSibling:e.parentElement.previousElementSibling.lastElementChild:a?e.nextElementSibling.nextElementSibling:e.parentElement.nextElementSibling.children[0];return this.getOffsetRange(o,r,i)}rangeToInputTag(t){const e=t.children[0].childNodes[0];this.setInputTagRange(e,e.textContent===this.VOID_KEY?1:e.textContent.length)}watchInputTag(t){if(t.childNodes.length===0||t.textContent.length===0)t.textContent=this.VOID_KEY,this.rangeToInputTag(t.parentElement);else{const e=t.childNodes[0];this.target.nextTick(()=>{if(!this.target.chatEvent.isComposition){const s=window.getSelection().focusOffset,n=t.textContent===this.VOID_KEY||t.textContent.indexOf(this.VOID_KEY)===-1?0:1;let a=!1;n===1&&(e.textContent=e.textContent.replace(this.VOID_KEY,""),a=!0),t.textContent.indexOf(this.INPUT_TAG_WRAP_KEY[1])!==-1&&(t.textContent=t.textContent.replace(new RegExp(this.INPUT_TAG_WRAP_KEY[0],"g"),"").replace(new RegExp(this.INPUT_TAG_WRAP_KEY[1],"g"),this.INPUT_TAG_WRAP_KEY),a=!0),a&&this.setInputTagRange(t.childNodes[0],s-n)}})}f(t.nextElementSibling,t.textContent===this.VOID_KEY,"inline")}backRuleInputTag(t){if(t.textContent===this.VOID_KEY)return this.delTag(t.parentElement.parentElement),!0;const e=window.getSelection();if(e.focusOffset===0&&e.isCollapsed){const s=t.parentElement.parentElement.previousElementSibling.children[0].childNodes[0];return this.restCursorPos(s,s.textContent===this.VOID_KEY?1:s.textContent.length),!0}if(e.focusNode.textContent.indexOf(this.INPUT_TAG_WRAP_KEY[1])!==-1){const i=this.getDiffInputTagOffset(e.focusNode,e.focusOffset,"left");if(i>0){const s=e.focusNode.textContent.slice(0,e.focusOffset-1-i),n=e.focusNode.textContent.slice(e.focusOffset);return e.focusNode.textContent=s+n,e.focusNode.textContent?this.setInputTagRange(e.focusNode,s.length):(e.focusNode.textContent=this.VOID_KEY,this.watchInputTag(e.focusNode.parentElement),this.setInputTagRange(e.focusNode,1)),!0}}return!1}mergeRuleInputTag(t){this.target.nextTick(()=>{t.childNodes.length>1&&(t.removeChild(t.childNodes[1]),this.watchInputTag(t))})}inputTagSwitchRange(t){const{focusNode:e,focusOffset:i}=window.getSelection(),s=e.textContent.length,n=e.parentElement.parentElement.parentElement;let a,l,o=!1,r;switch(t){case"ArrowLeft":i>0&&e.textContent!==this.VOID_KEY?(r=this.getDiffInputTagOffset(e,i,"left"),l=i-1-r,a=e):(a=n.previousElementSibling.children[0].childNodes[0],l=a.textContent===this.VOID_KEY?1:a.textContent.length,o=!0);break;case"ArrowRight":i<s&&e.textContent!==this.VOID_KEY?(r=this.getDiffInputTagOffset(e,i,"right"),l=i+1+r,a=e):(a=n.nextElementSibling.children[0].childNodes[0],l=a.textContent===this.VOID_KEY?1:0,o=!0);break}o?this.restCursorPos(a,l):this.setInputTagRange(a,l)}setInputTagRange(t,e){const i=new Range;i.setStart(t,e),i.setEnd(t,e);const s=window.getSelection();s&&(s.removeAllRanges(),s.addRange(i))}pasteInputTag(t){t=t.replace(new RegExp(this.INPUT_TAG_WRAP_KEY[0],"g"),"").replace(new RegExp(this.INPUT_TAG_WRAP_KEY[1],"g"),this.INPUT_TAG_WRAP_KEY);const e=window.getSelection(),{focusNode:i,focusOffset:s,anchorOffset:n}=e;let a="",l="";e.isCollapsed?(a=i.textContent.slice(0,s)||"",l=i.textContent.slice(s)||""):(a=i.textContent.slice(0,n<s?n:s)||"",l=i.textContent.slice(s>n?s:n)||""),i.textContent=a+t+l,this.setInputTagRange(i,(n<s?n:s)+t.length);const o=i.parentElement;this.watchInputTag(o)}setInputTagWrap(t){const e=window.getSelection(),{focusOffset:i}=e,s=t.textContent,n=s.slice(0,i),a=s.slice(i);t.textContent=n+this.INPUT_TAG_WRAP_KEY+a,this.setInputTagRange(t.childNodes[0],i+this.INPUT_TAG_WRAP_KEY.length),this.watchInputTag(t)}getDiffInputTagOffset(t,e,i){const s=i==="left"?t.textContent[e-1]:t.textContent[e];if(this.INPUT_TAG_WRAP_KEY.indexOf(s)===-1)return 0;switch(i){case"left":return t.textContent[e-2]===this.INPUT_TAG_WRAP_KEY[1]?2:t.textContent[e-2]===this.INPUT_TAG_WRAP_KEY[0]?3:1;case"right":return t.textContent[e+1]===this.INPUT_TAG_WRAP_KEY[1]?2:t.textContent[e+1]===this.INPUT_TAG_WRAP_KEY[0]?3:1}}}const ft={device:"auto",autoFocus:!0,needDialog:!0,needDebounce:!0,asyncMatch:!1,userList:[],reformList:[],placeholder:"",maxLength:void 0,copyType:["text"],uploadImage:void 0,needCallEvery:!0,needCallSpace:!1,userProps:{},customTrigger:[],dialogLabels:{pcPointDialog:{},pcPCheckDialog:{},h5Dialog:{}},wrapKeyFun:u=>u.ctrlKey&&["Enter"].includes(u.key),sendKeyFun:u=>!u.ctrlKey&&["Enter"].includes(u.key)},X={id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"},Z={title:"群成员",callEveryLabel:"所有人",checkLabel:"多选",emptyLabel:"暂无数据"},J={title:"选择要@的人",searchPlaceholder:"搜素人员名称",searchEmptyLabel:"没有匹配到任何结果",userTagTitle:"研讨成员列表",checkAllLabel:"全选",checkEmptyLabel:"请选择需要@的成员",confirmLabel:"确定",cancelLabel:"取消"},Q={title:"选择提醒的人",callEveryLabel:"所有人",searchPlaceholder:"搜素人员名称",searchEmptyLabel:"没有匹配到任何结果",confirmLabel:"确定",cancelLabel:"收起"},xt={saveTagData:!1,needUserId:!1,needTagId:!1,needSelectId:!1,wrapClassName:void 0,rowClassName:void 0,imgToText:!1,identifyLink:!1},Tt=["Backspace","Shift","Tab","CapsLock","Control","Meta","Alt","ContextMenu","Enter","NumpadEnter","Escape","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Home","End","PageUp","PageDown","Insert","Delete","NumLock"],Ct={"!":"！",$:"￥","(":"（",")":"）","[":"【","]":"】","-":"——",";":"；",":":"：","\\":"、","'":"’",'"':"“","`":"·",",":"，","<":"《",".":"。",">":"》","?":"？"};class yt{constructor(t){C(this,"target");C(this,"outerApply",!1);C(this,"isComposition",!1);C(this,"matchKey",0);C(this,"startOpenIndex",0);C(this,"textLength",0);C(this,"isIMEModel",!1);C(this,"takeIMEModel",!1);C(this,"undoHistory",[]);C(this,"redoHistory",[]);C(this,"doOverHistory",!0);C(this,"notMergeKey",Tt);C(this,"tagProps",Ct);C(this,"chatEventModule",{enterSend:[],operate:[],defaultAction:[],atMatch:[],atCheck:[],tagCheck:[],selectCheck:[],afterAtCheck:[],afterTagCheck:[],afterSelectCheck:[],showAtDialog:[],showTagDialog:[],showSelectDialog:[],elementClicked:[]});C(this,"debounceEvents",{recordHistory:()=>{},dialogMoveToRange:t=>{},selectDialogToAim:()=>{},matchPointDialog:()=>{},movePointActiveUserElm:t=>{},moveCustomActiveTagElm:t=>{}});this.target=t,this.registerEvent(),this.otherEvent()}registerEvent(){const{chatElement:t,options:e,deviceInfo:i,chatInput:s}=this.target;t.richText.addEventListener("keyup",n=>{if(n.target.classList.contains("input-write"))return;if(n.stopPropagation(),i.isPc){n.keyCode===50||n.code==="Digit2"||n.key==="@"?(this.triggerChatEvent("showAtDialog"),e.needDialog&&t.ruleShowPointDialog()):e.customTrigger.map(r=>r.prefix).indexOf(n.key)!==-1&&(this.triggerChatEvent("showTagDialog",n.key),e.needDialog&&t.showCustomTagDialog(n.key));return}const a=n.key==="Unidentified"?"android":"ios";let l=!1;switch(a){case"android":l=n.keyCode===229;break;case"ios":l=n.keyCode===50||n.code==="Digit2"||n.key==="@";break}l&&(e.reformList.length>0||e.asyncMatch)&&s.showAt()&&(this.triggerChatEvent("showAtDialog"),e.needDialog&&this.target.showH5Dialog(),t.isExternalCallPopup=!1)}),t.richText.addEventListener("keydown",n=>{const a=n.target.classList.contains("input-write");if(!i.isPc&&n.key==="Unidentified"&&n.keyCode===229){a&&s.mergeRuleInputTag(n.target),this.isIMEModel=!0;return}if(!this.isIMEModel){if($(t.pcElms.pointDialogElm)){["ArrowUp","ArrowDown","Enter","NumpadEnter"].includes(n.code)?n.preventDefault():["ArrowLeft","ArrowRight"].includes(n.code)&&t.exitPointDialog();return}if(t.pcElms.customTagDialogTagKey&&$(t.pcElms.customTagDialogElms[t.pcElms.customTagDialogTagKey])){["ArrowUp","ArrowDown","Enter","NumpadEnter"].includes(n.code)?n.preventDefault():["ArrowLeft","ArrowRight"].includes(n.code)&&t.exitCustomTagDialog();return}if(n.code==="Backspace"||n.key==="Backspace"?a&&s.backRuleInputTag(n.target)?(n.preventDefault(),this.richTextInput()):s.selectRegionMerge()||s.gridElmMerge()||s.delMarkRule()?(n.preventDefault(),this.richTextInput()):t.tipElm&&this.target.isEmpty()&&t.removeTipElm():e.wrapKeyFun(n)||!i.isPc&&n.key==="Enter"?(n.preventDefault(),a?s.setInputTagWrap(n.target):s.setWrap(),this.richTextInput()):e.sendKeyFun(n)?(n.preventDefault(),setTimeout(()=>{this.triggerChatEvent("enterSend")},100)):["ArrowLeft","ArrowRight"].includes(n.code)?(n.preventDefault(),a?s.inputTagSwitchRange(n.code):s.switchRange(n.code)):n.ctrlKey&&n.code==="KeyA"?this.target.isEmpty()&&n.preventDefault():n.ctrlKey&&n.code==="KeyZ"?(n.preventDefault(),this.ruleChatEvent(()=>{this.target.undo()},"defaultAction","UNDO")):n.ctrlKey&&n.code==="KeyY"&&(n.preventDefault(),this.ruleChatEvent(()=>{this.target.redo()},"defaultAction","REDO")),!n.ctrlKey&&!n.altKey&&!n.metaKey){const l=this.notMergeKey.indexOf(n.key)===-1;a?(l||n.code==="Backspace"||n.key==="Backspace")&&s.mergeRuleInputTag(n.target):l&&s.selectRegionMerge()}}}),t.richText.addEventListener("beforeinput",n=>{const a=n.target.classList.contains("input-write");if(this.isIMEModel){if(n.inputType==="insertParagraph"){n.preventDefault(),a?s.setInputTagWrap(n.target):s.setWrap(),this.richTextInput();return}if(n.inputType==="deleteContentBackward"){this.takeIMEModel=!0,n.preventDefault();const l=t.richText.innerHTML,o=window.getSelection(),r=o.focusNode,h=o.focusOffset,c=a?r.parentElement.parentElement.parentElement:r.parentElement.parentElement,d=c.parentElement,g=Array.prototype.indexOf.call(t.richText.children,d),p=Array.prototype.indexOf.call(d.children,c);this.target.nextTick(()=>{t.richText.innerHTML=l;const y=t.richText.children[g].children[p],x=a?y.children[0].children[0].childNodes[0]:y.children[0].childNodes[0];a?(s.setInputTagRange(x,h),s.backRuleInputTag(x.parentElement)||(x.textContent=x.textContent.slice(0,h-1)+x.textContent.slice(h),s.setInputTagRange(x,h-1)),s.watchInputTag(x.parentElement)):(s.restCursorPos(x,h),s.selectRegionMerge()||s.gridElmMerge()||s.delMarkRule()||(x.textContent=x.textContent.slice(0,h-1)+x.textContent.slice(h),s.restCursorPos(x,h-1))),this.target.nextTick(async()=>{await this.richTextInput(),this.takeIMEModel=!1,this.isIMEModel=!1})})}}}),t.richText.addEventListener("input",async n=>{const a=n.target.classList.contains("input-write");if(this.isIMEModel){if(this.takeIMEModel)return;await this.target.nextTick(()=>{a&&s.watchInputTag(n.target),e.maxLength!==void 0&&this.ruleMaxLength(),t.showPlaceholder(),this.triggerChatEvent("operate"),this.isIMEModel=!1});return}if(a){s.watchInputTag(n.target),await this.richTextInput();return}await this.richTextInput(),i.isPc&&!this.isComposition&&this.debounceEvents.matchPointDialog()}),t.richText.addEventListener("copy",n=>{n.preventDefault(),this.ruleChatEvent(()=>{this.copyRange(n)},"defaultAction","COPY")}),t.richText.addEventListener("cut",n=>{n.preventDefault(),this.ruleChatEvent(()=>{this.copyRange(n),this.removeRange(),n.target.classList.contains("input-write")&&this.target.chatInput.watchInputTag(n.target)},"defaultAction","CUT")}),t.richText.addEventListener("paste",n=>{n.preventDefault();const{options:a,chatInput:l}=this.target;this.ruleChatEvent(()=>{const o=n.clipboardData.getData("text/plain");if(typeof o=="string"&&o!==""){if(a.copyType.indexOf("text")===-1)return;if(n.target.classList.contains("input-write")){l.pasteInputTag(o),this.richTextInput();return}let r=document.createElement("div");r.innerHTML=n.clipboardData.getData("application/my-custom-format")||"",l.selectRegionMerge(),r.children[0]&&r.children[0].getAttribute(E)===H?this.insertInsideHtml(r.innerHTML):(r.innerHTML=o,this.target.insertText(r.innerText)),r=null}else{if(a.copyType.indexOf("image")===-1)return;const h=(n.clipboardData||n.originalEvent.clipboardData).items||[];Array.from(h,async c=>{if(c.type.indexOf("image")===-1)return;const d=c.getAsFile();if(a.uploadImage){const g=await a.uploadImage(d);this.target.insertHtml(`<img class="chat-img" src="${g}" alt="" />`)}else{const g=new FileReader;g.onload=p=>{this.target.insertHtml(`<img class="chat-img" src="${p.target.result}" alt="" />`)},g.readAsDataURL(d)}})}},"defaultAction","PASTE")}),t.richText.addEventListener("blur",()=>{s.upDataNodeOrIndex()}),t.richText.addEventListener("focus",()=>{s.upDataNodeOrIndex()}),t.richText.addEventListener("click",n=>{s.upDataNodeOrIndex();const a=et(n.target,5);if(a){const l=a.children[0];if(l.classList.contains("chat-grid-input")){this.triggerChatEvent("elementClicked","gridInput",l);return}if(l.classList.contains("at-input")){l.children[0].textContent===s.VOID_KEY&&s.rangeToInputTag(l),this.triggerChatEvent("elementClicked","inputTag",l);return}if(l.classList.contains("at-select")){const o=l.getAttribute("data-select-key");this.triggerChatEvent("showSelectDialog",o,l),e.needDialog&&this.target.showPCSelectDialog(o,l),this.triggerChatEvent("elementClicked","selectTag",l);return}if(l.classList.contains("at-user")){this.triggerChatEvent("elementClicked","userTag",l);return}if(l.classList.contains("at-tag")){this.triggerChatEvent("elementClicked","customTag",l);return}if(l.classList.contains("chat-set-html")){this.triggerChatEvent("elementClicked","htmlTag",l.children[0]);return}}}),t.richText.addEventListener("dragstart",n=>{n.stopPropagation(),n.preventDefault()}),t.richText.addEventListener("dragover",n=>{n.stopPropagation(),n.preventDefault()}),t.richText.addEventListener("drop",n=>{n.stopPropagation(),n.preventDefault()}),t.richText.addEventListener("compositionstart",()=>{this.isComposition=!0}),t.richText.addEventListener("compositionend",()=>{this.isComposition=!1}),window.addEventListener("click",this.winClick.bind(this)),window.addEventListener("keydown",this.winKeydown.bind(this))}otherEvent(){const{options:t,chatInput:e,chatElement:i}=this.target,{needDebounce:s}=t,n=()=>{const{gridIndex:d,markIndex:g}=e.getRichTextNodeIndex(e.vnode);if(d===null||g==null)return;const p={html:i.richText.innerHTML,gridIndex:d,markIndex:g,cursorIndex:e.cursorIndex};this.undoHistory.push(p),this.undoHistory.length>50&&this.undoHistory.shift()};this.debounceEvents.recordHistory=s?Y(n,200):n;const a=d=>{let g="0",p="100%";const m=e.getRangeRect();if(!m)return;const y=i.pcElms.containerDialogElm.getBoundingClientRect();let x=m.x-y.x,D=y.y-m.y;const{clientWidth:v,clientHeight:k}=d;m.x>window.innerWidth-v-30&&(x=m.x-v-y.x-16,g="100%"),m.y<k&&(D=D-k,p="0"),d.style.transform="translate(0, 0)",d.style.transformOrigin=`${g} ${p}`,d.style.left=x+6+"px",d.style.bottom=`${D}px`,d.style.opacity="1"};this.debounceEvents.dialogMoveToRange=s?Y(a,120,!0):a;const l=()=>{if(!t.needDialog)return;const d=e.vnode.textContent||"",g=e.cursorIndex,p=d.slice(0,g);let m=-1,y=-1,x="userTag";p.lastIndexOf("@")!==-1&&(m=p.lastIndexOf("@")),i.pcElms.customTagDialogTagKey&&p.lastIndexOf(i.pcElms.customTagDialogTagKey)!==-1&&(y=p.lastIndexOf(i.pcElms.customTagDialogTagKey));const D=this.tagProps[i.pcElms.customTagDialogTagKey];if(D&&p.lastIndexOf(D)!==-1&&(y=p.lastIndexOf(D)),y>m&&(x="customTag"),x==="userTag"&&t.asyncMatch){if(m<0){i.exitPointDialog();return}this.matchKey++;const N=this.matchKey;this.startOpenIndex=m+1;const w=p.slice(this.startOpenIndex)||"";if(/\s/ig.test(w)){i.exitPointDialog();return}this.target.updateUserList([]),f(i.pcElms.pointDialogLoadingElm,!0,"flex"),f(i.pcElms.pointDialogEmptyElm),i.showPointDialog();const K=this.triggerChatEvent("atMatch",w).find(P=>P&&P instanceof Promise);K&&K.then(P=>{if(N===this.matchKey){if(f(i.pcElms.pointDialogLoadingElm),!P||P.length<=0){f(i.pcElms.pointDialogEmptyElm,!0,"flex");return}this.target.updateUserList(P),i.pcElms.pointDialogUsersElm&&i.pcElms.pointDialogUsersElm.length>0&&i.updatePointActiveUserElm(i.pcElms.pointDialogUsersElm[0].elm)}});return}if(x==="userTag"&&t.reformList.length<=0||x==="customTag"&&i.customTags[i.pcElms.customTagDialogTagKey].length<=0)return;const v=()=>{x==="userTag"?i.exitPointDialog():i.exitCustomTagDialog()},k=()=>{x==="userTag"?i.showPointDialog():i.showCustomTagDialog(i.pcElms.customTagDialogTagKey)};if(m<0&&y<0){i.exitPointDialog(),i.exitCustomTagDialog();return}this.startOpenIndex=x==="userTag"?m+1:y+1;const L=new RegExp(`^([${e.ZERO_WIDTH_KEY}${e.VOID_KEY}])+$`);if(!p||L.test(p)||g<this.startOpenIndex){v();return}const A=p.slice(this.startOpenIndex)||"";if(/\s/ig.test(A)){v();return}if(!A){k();return}if(x==="userTag"){const N=this.target.searchUserList(A);N.length>0?i.showPointDialog(N):v()}else{const w=i.customTags[i.pcElms.customTagDialogTagKey].filter(S=>W(S.name,S.pinyin||"",A));w.length>0?i.showCustomTagDialog(i.pcElms.customTagDialogTagKey,w):v()}};this.debounceEvents.matchPointDialog=s?Y(l,200):l;const o=d=>{if(!i.pcElms.pointDialogActiveElm)return;let g=0;const p=i.pcElms.pointDialogActiveElm.getAttribute("data-set-id");i.pcElms.pointDialogUsersElm.some(D=>{const v=D.elm.getAttribute("data-set-id");return g=D.index,p===v});const m=i.pcElms.pointDialogUsersElm.filter(D=>!D.elm.classList.contains("user-no-match")),y=m.map(D=>D.index);let x;d==="down"?g===m[m.length-1].index?x=m[0]:x=m[y.indexOf(g)+1]:d==="up"&&(g===m[0].index?x=m[m.length-1]:x=m[y.indexOf(g)-1]),x&&i.updatePointActiveUserElm(x.elm,!0)};this.debounceEvents.movePointActiveUserElm=z(o,80);const r=d=>{if(!i.pcElms.customTagDialogActiveElm)return;const g=i.customTags[i.pcElms.customTagDialogTagKey].map(v=>v.id),p=i.pcElms.customTagDialogActiveElm.getAttribute("data-set-id"),m=g.indexOf(p),y=Array.from(i.pcElms.customTagDialogElms[i.pcElms.customTagDialogTagKey].children[1].children,(v,k)=>({elm:v,index:k})).filter(v=>!v.elm.classList.contains("tag-no-match")),x=y.map(v=>v.index);let D;d==="down"?m===y[y.length-1].index?D=y[0]:D=y[x.indexOf(m)+1]:d==="up"&&(m===y[0].index?D=y[y.length-1]:D=y[x.indexOf(m)-1]),D&&i.updateActiveCustomTagElm(D.elm,!0)};this.debounceEvents.moveCustomActiveTagElm=z(r,80);const h=()=>{const d=i.pcElms.selectDialogAim.getClientRects()[0],g=i.pcElms.selectDialogElms[i.pcElms.selectDialogKey];f(g,!0);const p=g.querySelector(".chat-select-arrow");let m=g.clientHeight+16;if(m>d.y?(m=-(d.height+16),p.style.top="-16px",p.style.bottom="auto",p.style.transform="rotate(0deg)"):(p.style.transform="rotate(180deg)",p.style.bottom="-16px",p.style.top="auto"),window.innerWidth-d.x<g.clientWidth){const L=g.clientWidth-(window.innerWidth-d.x)-10;g.style.left="auto",g.style.right="10px",p.style.left="auto",p.style.right=L-p.clientWidth/2+d.width/2+"px"}else g.style.left=d.x+"px",g.style.right="auto",p.style.left=d.width/2-p.clientWidth/2+"px",p.style.right="auto";g.style.top=d.y+"px",g.style.transform=`translateY(${-m}px)`;const y=g.querySelector(".chat-select-dialog-main"),x=g.querySelectorAll(".chat-select-dialog-item");let D=0,v=!1,k=0;if(i.pcElms.selectDialogAim.classList.contains("at-select")){const L=i.pcElms.selectDialogAim.getAttribute("data-select-id");T(i.pcElms.selectDialogAim,"aim",!0),Array.from(x,N=>{const w=N.lastChild.lastChild,S=L===N.getAttribute("data-set-id");S&&(k=N.clientHeight,v=!0),!S&&!v&&(D+=N.clientHeight),f(w,S,"inline-block")});const A=D-y.clientHeight/2+k/2;y.scrollTop=A>0?A:0}else Array.from(x,L=>{const A=L.lastChild.lastChild;f(A,!1,"inline-block")})};this.debounceEvents.selectDialogToAim=s?Y(h,120):h;const c={html:i.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:e.cursorIndex};this.undoHistory=[c]}winClick(){if(!this.target||this.outerApply)return;const{chatElement:t}=this.target;$(t.pcElms.pointDialogElm)&&t.exitPointDialog(),t.pcElms.checkDialogSearchResultElm&&f(t.pcElms.checkDialogSearchResultElm),t.pcElms.customTagDialogTagKey&&$(t.pcElms.customTagDialogElms[t.pcElms.customTagDialogTagKey])&&t.exitCustomTagDialog(),t.pcElms.selectDialogKey&&$(t.pcElms.selectDialogElms[t.pcElms.selectDialogKey])&&t.exitSelectDialog()}async winKeydown(t){if(!this.target)return;const{chatElement:e,options:i}=this.target;if(t.ctrlKey&&t.code==="KeyZ"&&t.preventDefault(),!this.isComposition){if($(e.pcElms.pointDialogElm)){if(t.code==="ArrowDown"){t.preventDefault(),this.debounceEvents.movePointActiveUserElm("down");return}if(t.code==="ArrowUp"){t.preventDefault(),this.debounceEvents.movePointActiveUserElm("up");return}if((t.code==="Enter"||t.code==="NumpadEnter")&&e.pcElms.pointDialogActiveElm){t.preventDefault();const s=e.pcElms.pointDialogActiveElm.getAttribute("data-set-id");if(await U(100),e.isPointSearchMode||i.asyncMatch)await this.target.matchSetTag(i.reformList.find(n=>n.id===s));else{const n=i.userList.find(a=>String(a[i.userProps.id])===s);await this.target.onceSetTag(n)}e.exitPointDialog()}}else if(e.pcElms.customTagDialogTagKey&&$(e.pcElms.customTagDialogElms[e.pcElms.customTagDialogTagKey])){if(t.code==="ArrowDown"){t.preventDefault(),this.debounceEvents.moveCustomActiveTagElm("down");return}if(t.code==="ArrowUp"){t.preventDefault(),this.debounceEvents.moveCustomActiveTagElm("up");return}if((t.code==="Enter"||t.code==="NumpadEnter")&&e.pcElms.customTagDialogActiveElm){t.preventDefault();const s=e.pcElms.customTagDialogActiveElm.getAttribute("data-set-id");await U(100);const a=e.customTags[e.pcElms.customTagDialogTagKey].find(l=>l.id===s);e.isPointSearchMode?await this.target.matchSetCustomTag(a):await this.target.onceSetCustomTag(a),e.exitCustomTagDialog()}}}}async richTextInput(t=!0){const{chatInput:e,deviceInfo:i,chatElement:s,options:n}=this.target;return e.upDataNodeOrIndex(),i.isPc&&e.selectRegionMerge(),await this.target.nextTick(()=>{this.isComposition||e.updateGrid();const l=(s.richText.children[0]||{children:[]}).children[0];if(!l||!l.getAttribute||l.getAttribute(E)!==b){e.initEditor(!0),s.showPlaceholder(),this.triggerChatEvent("operate");return}n.maxLength!==void 0&&this.ruleMaxLength(),s.showPlaceholder(),this.triggerChatEvent("operate"),t&&this.doOverHistory&&!this.isComposition&&this.debounceEvents.recordHistory(),e.viewIntoPoint()}),!0}ruleMaxLength(){const{options:t,chatElement:e}=this.target;if(this.target.isEmpty()||t.maxLength===void 0){this.textLength=0;return}let i=0,s=0;const n=[];Array.prototype.some.call(e.richText.children,(l,o)=>{const{nodeInfos:r,nodeTextLength:h}=this.getGirdNodeTextInfo(l);if(i+=h,n.push(r),s=o,i>=t.maxLength)return!0});const a=[];Array.from(e.richText.children,(l,o)=>{o>s&&a.push(l)}),a.forEach(l=>e.richText.removeChild(l)),this.deepDelGirdText(n,i)}getGirdNodeTextInfo(t){const{chatInput:e}=this.target,i=[];let s=0;if(t.children.length===1&&t!==t.parentElement.children[0]){const n=t.children[0],a=(n.textContent||"").replace(new RegExp(e.VOID_KEY,"g"),"");s+=a.length||1,i[0]={node:n,textLength:a.length||1,type:b}}else Array.from(t.children,(n,a)=>{if(n.getAttribute(E)===b){const o=(n.textContent||"").replace(new RegExp(e.VOID_KEY,"g"),"");s+=o.length,i[a]={node:n,textLength:o.length,type:b}}else{const o=(n.textContent||"").replace(new RegExp(e.VOID_KEY,"g"),"");s+=o.length||1,i[a]={node:n,textLength:o.length||1,type:M}}});return{nodeInfos:i,nodeTextLength:s}}deepDelGirdText(t,e){if(e>this.target.options.maxLength){const i=t[t.length-1];t.pop(),this.deepDelNode(i,t,e)}else this.textLength=e}deepDelNode(t,e,i){const s=t[0].node.parentElement;if(i>this.target.options.maxLength){let n=i-this.target.options.maxLength,a=t[t.length-1];if(a.type===b)if(a.textLength===0||n>=a.textLength)s.removeChild(a.node),t.pop(),n=n-a.textLength,a=t[t.length-1],s.removeChild(a.node),t.pop(),n=n-a.textLength;else{const l=a.node.childNodes[0];l.textContent=l.textContent.slice(0,a.textLength-n),l.textContent===0&&(l.setAttribute(I,"true"),l.innerHTML=`${this.target.chatInput.VOID_KEY}<br>`),n=0}else s.removeChild(a.node),t.pop(),n=n-a.textLength;n>0?t.length>0?this.deepDelNode(t,e,n+this.target.options.maxLength):(this.target.chatElement.richText.appendChild(s),this.deepDelGirdText(e,n+this.target.options.maxLength)):(this.textLength=this.target.options.maxLength+n,this.target.chatInput.setRangeLastText())}}copyRange(t){const e=window.getSelection();if(e.isCollapsed||e.rangeCount<=0){t.clipboardData.setData("application/my-custom-format",""),t.clipboardData.setData("text/plain","");return}const{chatElement:i,chatInput:s}=this.target,n=e.toString()||"";let a=document.createElement("div");a.innerHTML=n;const l=a.innerText.replace(/\n\n/g,`
`);a=null,t.clipboardData.setData("text/plain",l);const o=e.anchorNode,r=e.focusNode;if(o===r&&o.nodeType===Node.TEXT_NODE){t.clipboardData.setData("application/my-custom-format",l);return}if(o===i.richText&&r===i.richText){t.clipboardData.setData("application/my-custom-format",i.richText.innerHTML);return}const h=s.getWrapNode(o,!0),c=s.getWrapNode(r,!0),d=s.getMarkNode(o,!0),g=s.getMarkNode(r,!0),p=d.getAttribute(E)===b,m=g.getAttribute(E)===b,y=Array.prototype.indexOf.call(h.childNodes,d),x=Array.prototype.indexOf.call(c.childNodes,g);if(h===c&&h.parentNode===i.richText){const D=y>x,v=Array.prototype.filter.call(h.childNodes,(K,P)=>D?P<y&&P>x:P>y&&P<x).map(K=>K.cloneNode(!0)),k=p?D?o.textContent.slice(0,e.anchorOffset):o.textContent.slice(e.anchorOffset):"",L=m?D?r.textContent.slice(e.focusOffset):r.textContent.slice(0,e.focusOffset):"",A=s.getGridElm(!0),N=s.getGridElm(!0);k&&(A.childNodes[0].innerHTML=k,A.childNodes[0].setAttribute(I,"false")),L&&(N.childNodes[0].innerHTML=L,N.childNodes[0].setAttribute(I,"false")),D?(v[0].getAttribute(E)!==b&&v.unshift(N),v[v.length-1].getAttribute(E)!==b&&v.push(A)):(v[0].getAttribute(E)!==b&&v.unshift(A),v[v.length-1].getAttribute(E)!==b&&v.push(N));let w=document.createElement("div");const S=s.setWrapNodeByMark(v);w.appendChild(S),t.clipboardData.setData("application/my-custom-format",w.innerHTML),w=null;return}if(h.parentNode===i.richText&&c.parentNode===i.richText){const D=Array.prototype.indexOf.call(i.richText.childNodes,h),v=Array.prototype.indexOf.call(i.richText.childNodes,c),k=D>v,L=Array.prototype.filter.call(i.richText.childNodes,(O,R)=>k?R<D&&R>v:R>D&&R<v).map(O=>O.cloneNode(!0)),A=p?k?o.textContent.slice(0,e.anchorOffset):o.textContent.slice(e.anchorOffset):"",N=m?k?r.textContent.slice(e.focusOffset):r.textContent.slice(0,e.focusOffset):"",w=s.getGridElm(!0),S=s.getGridElm(!0);A&&(w.childNodes[0].innerHTML=A,w.childNodes[0].setAttribute(I,"false")),N&&(S.childNodes[0].innerHTML=N,S.childNodes[0].setAttribute(I,"false"));const K=Array.prototype.filter.call(h.childNodes,(O,R)=>k?R<y:R>y).map(O=>O.cloneNode(!0)),P=Array.prototype.filter.call(c.childNodes,(O,R)=>k?R>x:R<x).map(O=>O.cloneNode(!0));if(k){K.push(w),P.unshift(S);const O=s.setWrapNodeByMark(K),R=s.setWrapNodeByMark(P);L.push(O),L.unshift(R)}else{K.unshift(w),P.push(S);const O=s.setWrapNodeByMark(K),R=s.setWrapNodeByMark(P);L.unshift(O),L.push(R)}let V=document.createElement("div");Array.from(L,O=>{V.appendChild(O)}),t.clipboardData.setData("application/my-custom-format",V.innerHTML),V=null;return}}removeRange(){const{chatInput:t,chatElement:e}=this.target;window.getSelection().getRangeAt(0).deleteContents(),this.target.nextTick(()=>{t.updateGrid(),e.showPlaceholder()})}async setChatHistory(t){const{chatElement:e,chatInput:i}=this.target;this.doOverHistory=!1;const{html:s,gridIndex:n,markIndex:a,cursorIndex:l}=t;e.richText.innerHTML=s;const o=e.richText.childNodes[n].childNodes[a].childNodes[0].childNodes[0];i.restCursorPos(o,l),await this.richTextInput(),this.doOverHistory=!0}async insertInsideHtml(t){const{chatInput:e}=this.target;let i=document.createElement("div");i.innerHTML=t,i.children.length&&(i.children.length===1?e.insetRangeGrid(i.children[0]):e.insetRangeGrids(i.children),i=null,await this.richTextInput())}triggerChatEvent(t,...e){const i=[];return this.chatEventModule[t].forEach(s=>{s&&i.push(s(...e))}),i}ruleChatEvent(t,e,...i){this.triggerChatEvent(e,...i).some(n=>n&&n==="PREVENT")||(t&&t.bind(this)(),t=null)}}class It{constructor(t){C(this,"target");C(this,"rankLen",4);this.target=t}getCurrentNodes(){const t=[];return Array.from(this.target.chatElement.richText.children,(e,i)=>{t.push(this.analyzeGrid(e,i))}),t}getRank(t){let e=t+1+"";const i=this.rankLen-e.length;for(let s=0;s<i;s++)e="0"+e;return e}analyzeGrid(t,e){const i={type:"gridBox",rank:this.getRank(e),children:[]};return Array.from(t.children,(s,n)=>{switch(s.getAttribute(E)){case b:i.children.push(this.analyzeMark(s,n,i.rank));break;case M:i.children.push(this.analyzeTag(s,n,i.rank));break}}),i}analyzeMark(t,e,i){return{type:"gridInput",rank:i+this.getRank(e),text:t.textContent.replace(new RegExp(this.target.chatInput.VOID_KEY,"g"),"")}}analyzeTag(t,e,i){const s=t.children[0],n={type:"htmlTag",rank:i+this.getRank(e)};return s.classList.contains("at-user")?(n.type="userTag",n.dataset={[this.target.options.userProps.id]:s.getAttribute("data-user-id"),[this.target.options.userProps.name]:s.textContent.slice(1)}):s.classList.contains("at-tag")?(n.type="customTag",n.dataset={id:s.getAttribute("data-tag-id"),name:s.textContent.slice(1),prefix:s.getAttribute("data-set-prefix")}):s.classList.contains("at-select")?(n.type="selectTag",n.dataset={id:s.getAttribute("data-select-id"),name:s.textContent,key:s.getAttribute("data-select-key")}):s.classList.contains("at-input")?(n.type="inputTag",n.dataset={key:s.getAttribute("data-input-key"),placeholder:s.children[1].textContent,value:s.children[0].textContent===this.target.chatInput.VOID_KEY?"":s.children[0].textContent.replace(new RegExp(this.target.chatInput.INPUT_TAG_WRAP_KEY[0],"g"),"")}):(n.type="htmlTag",n.html=t.children[0].innerHTML),n}analyzeGridNodes(t){t.children=t.children||[];const e=t.children;if(e.length===0){e.push({type:"gridInput",rank:t.rank+this.getRank(0),text:""});return}const i=[];e.forEach((n,a)=>{if(a===e.length-1)return;const l=a+1;if(n.type==="gridInput"&&e[l].type==="gridInput"){let o=l-i.length;i.push(o)}}),i.forEach(n=>{const a=e[n];e[n-1].text+=a.text,e.splice(n,1)});const s=[];e.forEach((n,a)=>{if(a===e.length-1)return;const l=a+1;if(n.type!=="gridInput"&&e[l].type!=="gridInput"){let o=l+s.length;s.push(o)}}),s.forEach(n=>{e.splice(n,0,{type:"gridInput",rank:"",text:""})}),e[0].type!=="gridInput"&&e.unshift({type:"gridInput",rank:"",text:""}),e[e.length-1].type!=="gridInput"&&e.push({type:"gridInput",rank:"",text:""}),e.forEach((n,a)=>{n.rank=t.rank+this.getRank(a)})}analyzeNode(t,e=!1){switch(t.type){case"gridInput":return`<span ${E}="${b}"><span class="chat-grid-input" ${E}="${_}" ${I}="${String(t.text==="")}">${t.text===""?this.target.chatInput.VOID_KEY:t.text}${e&&t.text===""?"<br>":""}</span></span>`;case"userTag":return`<span class="chat-tag" contenteditable="false" ${E}="${M}"><span class="at-user" data-user-id="${t.dataset[this.target.options.userProps.id]}">@${t.dataset[this.target.options.userProps.name]}</span></span>`;case"customTag":return`<span class="chat-tag" contenteditable="false" ${E}="${M}"><span class="at-tag" data-tag-id="${t.dataset.id}" data-set-prefix="${t.dataset.prefix}">${t.dataset.prefix}${t.dataset.name}</span></span>`;case"selectTag":return`<span class="chat-tag" contenteditable="false" ${E}="${M}"><span class="at-select" data-select-id="${t.dataset.id}" data-select-key="${t.dataset.key}">${t.dataset.name}${B}</span></span>`;case"htmlTag":return`<span class="chat-tag" contenteditable="false" ${E}="${M}"><span class="chat-set-html">${t.html}</span></span>`;case"inputTag":const i=!t.dataset.value,s=i?`<span class="input-tip">${t.dataset.placeholder}</span>`:`<span class="input-tip chat-view-show" style="display: none">${t.dataset.placeholder}</span>`;return`<span class="chat-tag" contenteditable="false" ${E}="${M}"><span class="at-input" contenteditable="false" data-input-key="${t.dataset.key}"><span class="input-write" contenteditable="true">${i?this.target.chatInput.VOID_KEY:t.dataset.value.replace(new RegExp(this.target.chatInput.INPUT_TAG_WRAP_KEY[1],"g"),this.target.chatInput.INPUT_TAG_WRAP_KEY)}</span>${s}</span></span>`;case"gridBox":let n="";return this.analyzeGridNodes(t),t.children.forEach((a,l)=>{n+=this.analyzeNode(a,l===t.children.length-1)}),`<p class="chat-grid-wrap" ${E}="${H}">${n}</p>`;default:return""}}async insertNode(t){if(t.type==="gridBox"){const e=this.analyzeNode(t);let i=document.createElement("div");i.innerHTML=e;const s=i.children[0],n=parseFloat(t.rank)-1;if(n===-1||n>this.target.chatElement.richText.children.length-1)this.target.chatElement.richText.appendChild(s);else{const r=this.target.chatElement.richText.children[n];if(!r)return;this.target.chatElement.richText.insertBefore(s,r)}const o=s.lastElementChild.children[0].childNodes[0];this.target.chatInput.restCursorPos(o,o.textContent===this.target.chatInput.VOID_KEY?1:o.textContent.length),i=null,await this.target.chatEvent.richTextInput()}else{const e=(t.text||"").length,i=t.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),s=this.getNodeByRank(i[0]);if(!s)return;const n=parseFloat(i[1])-1;n==-1?s.children.push(t):s.children.splice(n,0,t),await this.updateNode(s,()=>{if(t.type==="gridInput"){const a=n===-1||n>s.children.length-1,l=!a&&n%2===0,o=a?s.children[s.children.length-1]:s.children[l?n:n-1];this.setCursorNode(o,l?e:-1)}else{const a=s.children.indexOf(t);this.setCursorNode(s.children[a+1],0)}})}}async updateNode(t,e){const i=t.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),s=parseFloat(i[0])-1,n=this.target.chatElement.richText.children[s];if(t.type==="gridBox"){if(!n)return;this.analyzeGridNodes(t);let c="";if(t.children.forEach((d,g)=>{c+=this.analyzeNode(d,g===t.children.length-1)}),n.innerHTML=c,e)e();else{const p=n.lastElementChild.children[0].childNodes[0];this.target.chatInput.restCursorPos(p,p.textContent===this.target.chatInput.VOID_KEY?1:p.textContent.length)}await this.target.chatEvent.richTextInput();return}const a=parseFloat(i[1])-1,l=n.children[a],o=this.getNodeByRank(t.rank);if(!o||t.type!==o.type)return;let r,h;if(t.type==="gridInput"){const c=l.children[0];c.textContent=t.text;const d=c.textContent!=="";c.setAttribute(I,String(!d)),d||(c.innerHTML=l.nextElementSibling?this.target.chatInput.VOID_KEY:`${this.target.chatInput.VOID_KEY}<br>`),r=c.childNodes[0],h=r.textContent.length}else if(t.type==="userTag"){const c=l.children[0];c.setAttribute("data-user-id",t.dataset[this.target.options.userProps.id]),c.textContent=`@${t.dataset[this.target.options.userProps.name]}`,r=l.nextElementSibling.children[0].childNodes[0]}else if(t.type==="customTag"){const c=l.children[0];c.setAttribute("data-tag-id",t.dataset.id),c.setAttribute("data-set-prefix",t.dataset.prefix),c.textContent=`${t.dataset.prefix}${t.dataset.name}`,r=l.nextElementSibling.children[0].childNodes[0]}else if(t.type==="selectTag"){const c=l.children[0];c.setAttribute("data-select-id",t.dataset.id),c.setAttribute("data-select-key",t.dataset.key),c.childNodes[0].textContent=t.dataset.name,r=l.nextElementSibling.children[0].childNodes[0]}else t.type==="htmlTag"&&(l.children[0].innerHTML=t.html,r=l.nextElementSibling.children[0].childNodes[0]);e?e():this.target.chatInput.restCursorPos(r,h),await this.target.chatEvent.richTextInput()}getNodeByRank(t){if(!t)return null;const e=t.match(new RegExp(`.{1,${this.rankLen}}`,"g"));if(e.length===0)return null;const i=parseFloat(e[0])-1,s=i===-1?this.target.chatElement.richText.lastElementChild:this.target.chatElement.richText.children[i];if(!s)return null;if(e.length===1)return this.analyzeGrid(s,i===-1?this.target.chatElement.richText.children.length-1:i);i===-1&&(e[0]=this.getRank(this.target.chatElement.richText.children.length-1));const n=parseFloat(e[1])-1,a=n===-1?s.lastElementChild:s.children[n];return a?a.getAttribute(E)===b?this.analyzeMark(a,n===-1?s.children.length-1:n,e[0]):this.analyzeTag(a,n===-1?s.children.length-1:n,e[0]):null}async delNodeByRank(t){const e=this.getNodeByRank(t);if(e)if(e.type==="gridBox"){const i=parseFloat(t)-1,s=this.target.chatElement.richText.children[i],n=s.nextElementSibling||s.previousElementSibling;if(n){const l=n.lastElementChild.children[0].childNodes[0];this.target.chatInput.restCursorPos(l,l.textContent===this.target.chatInput.VOID_KEY?1:l.textContent.length)}this.target.chatElement.richText.removeChild(s),this.target.chatElement.richText.children.length===0&&this.target.chatInput.initEditor(!0),await this.target.chatEvent.richTextInput()}else if(e.type==="gridInput")e.text="",await this.updateNode(e);else{const i=e.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),s=this.getNodeByRank(i[0]),n=s.children[parseFloat(i[1])-1-1],a=n.text.length;s.children=s.children.filter(l=>l.rank!==t),await this.updateNode(s,()=>{this.setCursorNode(n,a)})}}async coverNodes(t){if(t.length<0)return;let e="";t.forEach(i=>{e+=this.analyzeNode(i)}),this.target.chatElement.richText.innerHTML=e,this.target.chatInput.setRangeLastText(),await this.target.chatEvent.richTextInput()}setCursorNode(t,e=-1){const i=t.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),s=parseFloat(i[0])-1,n=s===-1?this.target.chatElement.richText.lastElementChild:this.target.chatElement.richText.children[s];let a=null;if(t.type==="gridInput"){const l=parseFloat(i[1])-1;a=l===-1?n.lastElementChild:n.children[l]}else if(t.type==="gridBox")a=e===-1?n.lastElementChild:n.children[0];else if(t.type==="inputTag"){const l=parseFloat(i[1])-1,r=n.children[l].children[0].children[0].childNodes[0],h=r.textContent===this.target.chatInput.VOID_KEY?1:e===-1?r.textContent.length:e;this.target.chatInput.setInputTagRange(r,h)}else{const l=parseFloat(i[1])-1,o=n.children[l];a=e===-1?o.nextElementSibling:o.previousElementSibling,e=e===-1?0:-1}if(a){const l=a.children[0].childNodes[0];e===-1&&(e=l.textContent.length),this.target.chatInput.restCursorPos(l,l.textContent===this.target.chatInput.VOID_KEY?1:e)}}getCursorNode(){const t=window.getSelection(),e=t.focusNode;if(e&&e.parentElement&&e.parentElement.classList.contains("input-write")){const s=e.parentElement.parentElement.parentElement;return{node:this.analyzeTag(s,Array.prototype.indexOf.call(s.parentElement.children,s),this.getRank(Array.prototype.indexOf.call(this.target.chatElement.richText.children,s.parentElement))),offset:e.textContent===this.target.chatInput.VOID_KEY?0:t.focusOffset}}const i=this.target.chatInput.vnode.parentElement.parentElement;return{node:this.analyzeMark(i,Array.prototype.indexOf.call(i.parentElement.children,i),this.getRank(Array.prototype.indexOf.call(this.target.chatElement.richText.children,i.parentElement))),offset:this.target.chatInput.vnode.textContent===this.target.chatInput.VOID_KEY?0:this.target.chatInput.cursorIndex}}setSelectNodes(t,e,i=0,s=-1){let n,a;const l=t.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),o=e.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),r=this.target.chatElement.richText.children[parseFloat(l[0])-1],h=this.target.chatElement.richText.children[parseFloat(o[0])-1];if(t.type==="gridInput")n=r.children[parseFloat(l[1])-1];else if(t.type==="gridBox")n=i===-1?r.lastElementChild:r.children[0];else{const y=parseFloat(l[1])-1,x=r.children[y];n=i===-1?x.nextElementSibling:x.previousElementSibling,i=i===-1?0:-1}if(e.type==="gridInput")a=h.children[parseFloat(o[1])-1];else if(t.type==="gridBox")a=s===-1?h.lastElementChild:h.children[0];else{const y=parseFloat(o[1])-1,x=h.children[y];a=s===-1?x.nextElementSibling:x.previousElementSibling,s=s===-1?0:-1}const c=n.children[0].childNodes[0],d=a.children[0].childNodes[0],g=document.createRange(),p=parseFloat(t.rank)>parseFloat(e.rank);g[p?"setEnd":"setStart"](c,c.textContent===this.target.chatInput.VOID_KEY?1:i===-1?c.textContent.length:i),g[p?"setStart":"setEnd"](d,d.textContent===this.target.chatInput.VOID_KEY?1:s===-1?d.textContent.length:s);const m=window.getSelection();m.removeAllRanges(),m.addRange(g)}getElmByRank(t){const e=t.match(new RegExp(`.{1,${this.rankLen}}`,"g")),i=parseFloat(e[0])-1,s=i===-1?this.target.chatElement.richText.lastElementChild:this.target.chatElement.richText.children[i];if(e.length===1)return s;const n=parseFloat(e[1])-1;return n===-1?s.lastElementChild:s.children[n]}getRankByElm(t){const e=this.target.chatElement.richText.children;let i=null,s=null;return Array.prototype.find.call(e,(n,a)=>t===n?(i=a,!0):Array.prototype.find.call(n.children,(l,o)=>l===t?(i=a,s=o,!0):!1)),(i!==null?this.getRank(i):"")+(s!==null?this.getRank(s):"")}}const F=function(u,t,e){return u.forEach(i=>{if(e in i){const s=t.indexOf(String(i[e]));s!==-1&&(t[s]=i)}}),t.filter(i=>i[e])};class vt{constructor(t){C(this,"options");C(this,"deviceInfo",st());C(this,"chatElement");C(this,"chatInput");C(this,"chatEvent");switch(this.options=Object.assign({},ft,t),this.options.device=this.options.device.toLocaleLowerCase(),this.deviceInfo.isTablet&&(this.deviceInfo.isPc=!1),this.options.device){case"pc":this.deviceInfo.isPc=!0;break;case"h5":this.deviceInfo.isPc=!1;break}this.options.userProps=Object.assign({},X,t.userProps||{}),this.options.dialogLabels.pcPointDialog=Object.assign({},Z,G(t.dialogLabels,"pcPointDialog",{})),this.options.dialogLabels.pcPCheckDialog=Object.assign({},J,G(t.dialogLabels,"pcPCheckDialog",{})),this.options.dialogLabels.h5Dialog=Object.assign({},Q,G(t.dialogLabels,"h5Dialog",{})),this.chatElement=new mt(this),this.chatInput=new Et(this),this.chatEvent=new yt(this),this.updateConfig(t);const e=this;Object.defineProperty(this,"richText",{get(){return e.chatElement.richText}}),Object.defineProperty(this,"textLength",{get(){return e.chatEvent.textLength}}),this.options.autoFocus&&this.nextTick(()=>{this.chatElement.richText.focus()})}updateConfig(t){t.copyType!==void 0&&(this.options.copyType=t.copyType),t.userProps&&(this.options.userProps=Object.assign({},X,t.userProps)),t.uploadImage!==void 0&&(this.options.uploadImage=t.uploadImage),t.placeholder!==void 0&&(this.chatElement.placeholderElm.textContent=t.placeholder),t.maxLength!==void 0&&(this.options.maxLength=t.maxLength,this.chatEvent.ruleMaxLength()),(this.options.asyncMatch||t.needCallEvery!==void 0||t.userList)&&(this.options.needCallEvery=this.options.asyncMatch?!1:q(t.needCallEvery===void 0?this.options.needCallEvery:t.needCallEvery),this.updateUserList(this.options.asyncMatch?[]:t.userList)),t.needCallSpace!==void 0&&this.chatInput.setCallSpace(q(t.needCallSpace)),t.wrapKeyFun!==void 0&&(this.options.wrapKeyFun=t.wrapKeyFun),t.sendKeyFun!==void 0&&(this.options.sendKeyFun=t.sendKeyFun),this.options.needDialog&&t.customTrigger&&this.deviceInfo.isPc&&(this.options.customTrigger=t.customTrigger,this.chatElement.bindCustomTrigger()),this.options.needDialog&&t.selectList&&this.deviceInfo.isPc&&(this.options.selectList=t.selectList,this.chatElement.bindSelectList())}updateUserList(t=void 0){const{options:e,chatElement:i}=this;if(t){e.userList=JSON.parse(JSON.stringify(t));const n={[e.userProps.id]:"isALL",[e.userProps.name]:""};e.userList.unshift(n),e.reformList=t.map((a,l)=>{const o=a[e.userProps.id];if(!o&&o!==0)throw new Error(`配置项userList：下标第${l}项${e.userProps.id}值异常！`);return{id:String(o),name:String(a[e.userProps.name]||""),avatar:String(a[e.userProps.avatar]||""),pinyin:String(a[e.userProps.pinyin]||"")}})}const s=e.userList[0];s&&s[e.userProps.id]==="isALL"&&(s[e.userProps.name]=this.deviceInfo.isPc?e.dialogLabels.pcPointDialog.callEveryLabel:e.dialogLabels.h5Dialog.callEveryLabel),e.needDialog&&(this.deviceInfo.isPc?i.updatePCUser():i.updateH5User())}searchUserList(t){return this.options.reformList.filter(e=>W(e.name,e.pinyin||"",t))}getReduceNode(t){const e=Object.assign({},xt,t||{});e.saveTagData&&(e.needUserId=!0,e.needTagId=!0,e.needSelectId=!0);const i=/(https?|http|ftp|file):\/\/[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]/g,n=this.chatElement.richText.cloneNode(!0).children||[],a=document.createElement("div");return e.wrapClassName&&(a.className=e.wrapClassName),Array.from(n,(l,o)=>{const r=document.createElement("p");Array.from(l.children,h=>{const c=h.children[0];this.chatInput.getNodeEmpty(c)||(c.removeAttribute(E),c.removeAttribute("contenteditable"),c.removeAttribute(I),e.needUserId||c.removeAttribute("data-user-id"),e.needTagId||(c.removeAttribute("data-set-prefix"),c.removeAttribute("data-tag-id")),e.needSelectId||(c.removeAttribute("data-select-id"),c.removeAttribute("data-select-key")),e.imgToText&&c.firstChild&&c.firstChild.tagName==="IMG"&&(c.classList.add("img-to-text"),c.innerHTML=`[${c.firstChild.getAttribute("data-img-text")||"you need set data-img-text"}]`),e.identifyLink&&c.classList.contains("chat-grid-input")&&(c.innerHTML=c.innerHTML.replace(i,d=>`<a class="chat-grid-link" href="${d}" target="_blank">${d}</a>`)),c.classList.contains("at-select")&&(c.classList.remove("aim"),c.removeChild(c.lastChild)),c.classList.contains("at-input")&&(e.saveTagData?c.setAttribute("data-input-tip",c.children[1].textContent):c.removeAttribute("data-input-key"),c.textContent=c.children[0].textContent!==this.chatInput.VOID_KEY?c.children[0].textContent:c.children[1].textContent,c.textContent=c.textContent.replace(new RegExp(this.chatInput.INPUT_TAG_WRAP_KEY[0],"g"),"")),r.appendChild(c))}),e.rowClassName&&(r.className=e.rowClassName),r.innerHTML||(r.innerHTML="<br>"),a.appendChild(r)}),a}getText(t){let e="";const i=this.getReduceNode(t);return Array.from(i.children,(s,n)=>{e=e+(n>0?`
`:"")+s.textContent}),e}getHtml(t){return this.getReduceNode(t).innerHTML}async reverseAnalysis(t,e){if(!t)return;const i=document.createElement("div");i.innerHTML=t;const s=i.children;Array.from(s,n=>{n.className="chat-grid-wrap",n.setAttribute(E,H);const a=n.children,l={},o=[];Array.from(a,(c,d)=>{if(c.className.indexOf("chat-grid-input")!==-1){const m=c.textContent||"";c.className="",c.setAttribute(E,b),c.innerHTML=`<span class="chat-grid-input" ${E}="${_}" ${I}="false">${m}</span>`;return}if(c.tagName&&c.tagName.toLocaleUpperCase()==="BR"){const m=this.chatInput.getGridElm(!0);n.removeChild(c),n.appendChild(m);return}const g=c.cloneNode(!0);g.setAttribute("contenteditable","false");const p=document.createElement("span");p.className="chat-tag",p.setAttribute("contenteditable","false"),p.setAttribute(E,M),p.appendChild(g),l[d]=p,d!==a.length-1?a[d+1].className.indexOf("chat-grid-input")===-1&&o.push(d):o.push(d),d===0&&o.push(-1)});for(const c in l){const d=Number(c),g=l[c].lastChild;if(g.classList.contains("at-select"))g.innerHTML=`${g.textContent}${B}`;else if(g.classList.contains("at-input")){const p=g.textContent==="",m=p?`<span class="input-tip">${g.getAttribute("data-input-tip")}</span>`:`<span class="input-tip chat-view-hidden" style="display: none">${g.getAttribute("data-input-tip")}</span>`;g.innerHTML=`<span class="input-write" contenteditable="true">${p?this.chatInput.VOID_KEY:g.textContent.replace(new RegExp(this.chatInput.INPUT_TAG_WRAP_KEY[1],"g"),this.chatInput.INPUT_TAG_WRAP_KEY)}</span>${m}`,g.removeAttribute("data-input-tip")}d===a.length-1?(n.removeChild(a[d]),n.appendChild(l[c])):(n.insertBefore(l[c],a[d+1]),n.removeChild(a[d]))}const r=[],h=n.children;o.forEach(c=>{c===h.length-1?r.push("isEnd"):r.push(h[c+1])}),r.forEach(c=>{const d=this.chatInput.getGridElm(!0);if(c==="isEnd")n.appendChild(d);else{const g=d.children[0];g.childNodes.length>1&&g.removeChild(g.childNodes[1]),n.insertBefore(d,c)}})}),e?(this.chatInput.setRangeLastText(),await this.chatEvent.insertInsideHtml(i.innerHTML)):(this.chatElement.richText.innerHTML=i.innerHTML,this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput())}async insertHtml(t){if(!t)return;const e=document.createElement("span");e.innerHTML=t,e.className="chat-set-html";const i=this.chatInput.createNewDom(e);return this.chatInput.replaceRegContent(i,!1),await this.chatEvent.richTextInput(),i}async insertText(t){if(!t)return;const e=new RegExp(`[${this.chatInput.ZERO_WIDTH_KEY}|${this.chatInput.VOID_KEY}]`,"ig"),i=t.replace(e,"");if(!i)return;const s=i.split(`
`);let n="";s.forEach(a=>{const l=a!=="";n+=`<p class="chat-grid-wrap" ${E}="${H}"><span ${E}="${b}"><span class="chat-grid-input" ${E}="${_}" ${I}="${l?"false":"true"}">${l?a:this.chatInput.VOID_KEY+"<br>"}</span></span></p>`}),await this.chatEvent.insertInsideHtml(n)}getCallUserList(){const t=this.chatElement.richText.querySelectorAll(".at-user");if(t&&t.length>0){const e=Array.from(t,i=>i.dataset.userId);return F(this.options.userList,e,this.options.userProps.id)}else return[]}getCallUserTagList(){const t=this.chatElement.richText.querySelectorAll(".at-user");if(t&&t.length>0){const e=[];return Array.from(t,i=>{e.some(s=>s[this.options.userProps.id]===i.dataset.userId)||e.push({[this.options.userProps.id]:i.dataset.userId,[this.options.userProps.name]:i.textContent.slice(1)})}),e}else return[]}getCustomTagList(){const t=Object.keys(this.chatElement.customTags),e={},i=this.chatElement.richText.querySelectorAll(".at-tag");return t.forEach(s=>{let n=Array.prototype.filter.call(i,a=>a.getAttribute("data-set-prefix")===String(s)).map(a=>a.getAttribute("data-tag-id"));n=n.filter((a,l)=>n.indexOf(a)===l),e[s]=F(this.chatElement.customTags[s],n,"id")}),e}getSelectTagList(){const t=Object.keys(this.chatElement.selectTags),e={},i=this.chatElement.richText.querySelectorAll(".at-select");return t.forEach(s=>{let n=Array.prototype.filter.call(i,a=>a.getAttribute("data-select-key")===String(s)).map(a=>a.getAttribute("data-select-id"));n=n.filter((a,l)=>n.indexOf(a)===l),e[s]=F(this.chatElement.selectTags[s],n,"id")}),e}getInputTagList(){const t={},e=this.chatElement.richText.querySelectorAll(".at-input");return Array.from(e,i=>{const s=i.getAttribute("data-input-key"),n=i.children[0].textContent===this.chatInput.VOID_KEY?null:i.children[0].textContent;t[s]||(t[s]=[]),t[s].push(n)}),t}async clear(t){this.chatInput.initEditor(!0,t);const e={html:this.chatElement.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:this.chatInput.cursorIndex};this.chatEvent.undoHistory=[e],this.chatEvent.redoHistory=[],await this.chatEvent.richTextInput(!1)}isEmpty(t=!1){if((this.chatElement.richText.querySelectorAll(".chat-tag")||[]).length>0)return!1;const i=new RegExp(`^(${this.chatInput.ZERO_WIDTH_KEY}|<br>|${this.chatInput.VOID_KEY})+$`),s=this.chatElement.richText.querySelectorAll(".chat-grid-input")||[];return t?Array.prototype.every.call(s,n=>!n.innerHTML||!n.textContent||!n.textContent.trim()||i.test(n.innerHTML)):Array.prototype.every.call(s,n=>!n.innerHTML||!n.textContent||i.test(n.innerHTML))}dispose(){if(this.options.elm.removeChild(this.chatElement.richText),this.options.elm.removeChild(this.chatElement.placeholderElm),this.options.needDialog)if(this.deviceInfo.isPc){const t=this.chatElement.pcElms.containerDialogElm.parentElement;t&&t.removeChild(this.chatElement.pcElms.containerDialogElm)}else document.body.removeChild(this.chatElement.h5Elms.dialogElm)}showPCPointDialog(){this.options.needDialog&&(this.insertText("@"),this.options.asyncMatch&&f(this.chatElement.pcElms.pointDialogEmptyElm,!0,"flex"),this.chatEvent.outerApply=!0,this.chatElement.showPointDialog(),U(50).then(()=>{this.chatEvent.outerApply=!1}))}showPCCheckDialog(){!this.options.needDialog||this.options.asyncMatch||(this.chatEvent.winClick(),this.chatElement.checkboxRows=[],f(this.chatElement.pcElms.checkDialogElm,!0),T(document.body,"disable-scroll",!0),this.chatElement.pcElms.checkDialogTagsElm.scrollTop=0,this.chatElement.pcElms.checkDialogUsersElm.scrollTop=0,this.chatElement.pcElms.checkDialogSearchInputElm.value="",this.chatElement.updateCheckDialogTags(),this.chatElement.isExternalCallPopup=!0)}showPCCustomTagDialog(t){!this.options.needDialog||this.options.asyncMatch||(this.insertText(t),this.chatEvent.outerApply=!0,this.chatElement.showCustomTagDialog(t),U(50).then(()=>{this.chatEvent.outerApply=!1}))}showPCSelectDialog(t,e){this.chatElement.exitCustomTagDialog(),this.chatElement.exitPointDialog(),this.chatEvent.outerApply=!0,e&&(this.chatElement.exitSelectDialog(),this.chatElement.pcElms.selectDialogAim=e),this.chatElement.pcElms.selectDialogKey=t,this.chatEvent.debounceEvents.selectDialogToAim(),U(50).then(()=>{this.chatEvent.outerApply=!1})}showH5Dialog(){this.chatElement.richText&&this.chatElement.richText.blur(),Array.from(this.chatElement.h5Elms.dialogMainElm.children,t=>{t.style.display="",T(t,"user-popup-check-item-check")}),T(this.chatElement.h5Elms.dialogCheckElm,"disabled",!0),f(this.chatElement.h5Elms.dialogElm,!0),T(document.body,"disable-scroll",!0),this.options.asyncMatch&&f(this.chatElement.h5Elms.dialogEmptyElm,!0,"flex"),this.chatElement.h5Elms.dialogMainElm.scrollTop=0,this.chatElement.isExternalCallPopup=!0}disabled(){this.chatElement.richText.setAttribute("contenteditable","false"),T(this.chatElement.richText,"chat-rich-text-disabled",!0)}enable(){this.chatElement.richText.setAttribute("contenteditable","true"),T(this.chatElement.richText,"chat-rich-text-disabled"),this.chatInput.setRangeLastText()}async setUserTag(t){this.chatEvent.triggerChatEvent("atCheck",[t]);const e=this.chatInput.createChatTagElm({id:t[this.options.userProps.id],name:t[this.options.userProps.name]},"@","at-user","user-id");this.chatInput.replaceRegContent(e,!1),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterAtCheck",[t])}async setCustomTag(t,e){this.chatEvent.triggerChatEvent("tagCheck",t,e),await this.chatInput.onceCustomCall(t,!1,e),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterTagCheck",t,e)}async setSelectTag(t,e){if(e||(e=this.chatElement.pcElms.selectDialogKey),this.chatEvent.triggerChatEvent("selectCheck",t,e),this.chatElement.pcElms.selectDialogAim&&this.chatElement.pcElms.selectDialogAim.classList.contains("at-select")){const i=this.chatElement.pcElms.selectDialogAim.getAttribute("data-select-id"),n=this.chatElement.pcElms.selectDialogAim.parentElement.nextElementSibling.childNodes[0].childNodes[0];if(this.chatInput.restCursorPos(n),i===t.id)return;this.chatElement.pcElms.selectDialogAim.setAttribute("data-select-id",t.id),this.chatElement.pcElms.selectDialogAim.childNodes[0].textContent=t.name}else{const i=document.createElement("span");i.setAttribute("class","at-select"),i.setAttribute("data-select-key",e),i.setAttribute("data-select-id",t.id),i.innerHTML=`${t.name}${B}`;const s=this.chatInput.createNewDom(i);this.chatInput.replaceRegContent(s,!1)}await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterSelectCheck",t,e)}async setInputTag(t,e,i=""){const s=document.createElement("span");s.setAttribute("class","at-input"),s.setAttribute("contenteditable","false"),s.setAttribute("data-input-key",t);const n=document.createElement("span");n.setAttribute("class","input-write"),n.setAttribute("contenteditable","true"),n.textContent=i||this.chatInput.VOID_KEY;const a=document.createElement("span");a.setAttribute("class","input-tip"),a.textContent="["+(e||"Please input")+"]",s.appendChild(n),s.appendChild(a);const l=this.chatInput.createNewDom(s);this.chatInput.replaceRegContent(l,!1),i&&this.chatInput.watchInputTag(n),this.chatInput.rangeToInputTag(s),await this.chatEvent.richTextInput()}async matchSetTag(t){this.chatEvent.triggerChatEvent("atCheck",[t]),await this.chatInput.onceSearchCall(t,this.chatEvent.startOpenIndex),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterAtCheck",[t])}async onceSetTag(t){this.chatEvent.triggerChatEvent("atCheck",[t]),await this.chatInput.onceCall({id:t[this.options.userProps.id],name:t[this.options.userProps.name]}),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterAtCheck",[t])}async batchSetTag(t){this.chatEvent.triggerChatEvent("atCheck",t);const e=[];for(let i=0;i<=t.length-1;)e.push({id:t[i][this.options.userProps.id],name:t[i][this.options.userProps.name]}),i++;await this.chatInput.batchReplaceRegContent(e,!this.chatElement.isExternalCallPopup),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterAtCheck",t)}async onceSetCustomTag(t,e){e||(e=this.chatElement.pcElms.customTagDialogTagKey),this.chatEvent.triggerChatEvent("tagCheck",t,e),await this.chatInput.onceCustomCall(t,!0,e),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterTagCheck",t,e)}async matchSetCustomTag(t,e){e||(e=this.chatElement.pcElms.customTagDialogTagKey),this.chatEvent.triggerChatEvent("tagCheck",t,e),await this.chatInput.onceCustomCall(t,this.chatEvent.startOpenIndex,e),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterTagCheck",e)}async undo(){const{chatEvent:t}=this;if(!t.doOverHistory||!t.undoHistory||t.undoHistory.length<=1)return;const e=t.undoHistory[t.undoHistory.length-2],i=t.undoHistory[t.undoHistory.length-1];t.redoHistory.push(i),t.undoHistory.pop(),await t.setChatHistory(e)}async redo(){const{chatEvent:t}=this;if(!t.doOverHistory||!t.redoHistory||t.redoHistory.length<1)return;const e=t.redoHistory[t.redoHistory.length-1];t.redoHistory.pop(),t.undoHistory.push(e),await t.setChatHistory(e)}cursorMove(t){if(t===0){this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);return}const e=new RegExp(`[${this.chatInput.ZERO_WIDTH_KEY}|${this.chatInput.VOID_KEY}]`,"ig");if(t>0){const i=this.chatInput.vnode.textContent.replace(e,"").slice(this.chatInput.cursorIndex);if(i.length>=t){this.chatInput.cursorIndex+=t,this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);return}const s=this.chatInput.vnode.parentElement.parentElement,n=s.parentElement;let a=!!(s.nextElementSibling&&s.nextElementSibling.nextElementSibling);const l=!!n.nextElementSibling;if(!a&&!l){this.chatInput.cursorIndex+=i.length,this.chatInput.cursorIndex===0&&(this.chatInput.cursorIndex=1),this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);return}const o=t-i.length-1,r=a?s.nextElementSibling.nextElementSibling:n.nextElementSibling.children[0],{rangeNode:h,rangeIndex:c}=this.chatInput.getOffsetRange(o,r);this.chatInput.restCursorPos(h,c)}else if(t<0){let i=Math.abs(t);const s=this.chatInput.vnode.textContent.replace(e,"").slice(0,this.chatInput.cursorIndex);if(s.length>=i){this.chatInput.cursorIndex-=i,this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);return}const n=this.chatInput.vnode.parentElement.parentElement,a=n.parentElement,l=!!(n.previousElementSibling&&n.previousElementSibling.previousElementSibling),o=!!a.previousElementSibling;if(!l&&!o){this.chatInput.restCursorPos(this.chatInput.vnode);return}i=i-s.length-1;const r=l?n.previousElementSibling.previousElementSibling:a.previousElementSibling.lastElementChild,{rangeNode:h,rangeIndex:c}=this.chatInput.getOffsetRange(i,r,!0);this.chatInput.restCursorPos(h,c)}}async cursorDel(t){if(t===0){this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);return}const e=this.chatInput.vnode,i=this.chatInput.cursorIndex;this.cursorMove(t);const s=this.chatInput.vnode,n=this.chatInput.cursorIndex,a=document.createRange();t<0?(a.setStart(s,n),a.setEnd(e,i)):(a.setStart(e,i),a.setEnd(s,n));const l=window.getSelection();l.removeAllRanges(),l.addRange(a),(this.chatInput.selectRegionMerge()||this.chatInput.gridElmMerge()||this.chatInput.delMarkRule())&&await this.chatEvent.richTextInput()}async delUserTags(t){const e=t||this.options.userList.map(n=>n[this.options.userProps.id]),i=this.chatElement.richText.querySelectorAll(".at-user"),s=[];Array.from(i,n=>{const a=n.getAttribute("data-user-id");e.some(l=>String(l)===a)&&s.push(n.parentElement)});for(let n=0;n<s.length;){const a=s[n];this.chatInput.delTag(a),n++}this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput()}async delCustomTags(t,e){const i=this.options.customTrigger.find(l=>l.prefix===t);if(!i||i.tagList.length===0)return;const s=e||i.tagList.map(l=>l.id),n=this.chatElement.richText.querySelectorAll(".at-tag"),a=[];Array.from(n,l=>{const o=l.getAttribute("data-set-prefix"),r=l.getAttribute("data-tag-id");o===t&&s.some(h=>String(h)===r)&&a.push(l.parentElement)});for(let l=0;l<a.length;){const o=a[l];this.chatInput.delTag(o),l++}this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput()}async delSelectTags(t,e){const i=this.options.selectList.find(l=>l.key===t);if(!i||i.options.length===0)return;const s=e||i.options.map(l=>l.id),n=this.chatElement.richText.querySelectorAll(".at-select"),a=[];Array.from(n,l=>{const o=l.getAttribute("data-select-key"),r=l.getAttribute("data-select-id");o===t&&s.some(h=>String(h)===r)&&a.push(l.parentElement)});for(let l=0;l<a.length;){const o=a[l];this.chatInput.delTag(o),l++}this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput()}async delInputTags(t){const e=this.chatElement.richText.querySelectorAll(".at-input"),i=[];Array.from(e,s=>{if(!t)i.push(s.parentElement);else{const n=s.getAttribute("data-input-key");t.some(a=>String(a)===n)&&i.push(s.parentElement)}});for(let s=0;s<i.length;){const n=i[s];this.chatInput.delTag(n),s++}this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput()}openTipTag(t){this.chatElement.createTipElm(t),this.chatInput.setRangeLastText()}closeTipTag(){this.chatElement.tipElm&&this.chatElement.removeTipElm()}addEventListener(t,e){this.chatEvent.chatEventModule[t].push(e)}removeEventListener(t,e){const i=this.chatEvent.chatEventModule[t],s=i.indexOf(e);s!==-1&&i.splice(s,1)}revisePCPointDialogLabel(t){this.options.needDialog&&(this.options.dialogLabels.pcPointDialog=Object.assign({},Z,t||{}),this.chatElement.pcElms.pointDialogElm.querySelector(".call-user-dialog-header-title").textContent=this.options.dialogLabels.pcPointDialog.title,this.chatElement.pcElms.pointDialogCheckElm.textContent=this.options.dialogLabels.pcPointDialog.checkLabel,this.chatElement.pcElms.pointDialogEmptyElm&&(this.chatElement.pcElms.pointDialogEmptyElm.children[1].textContent=this.options.dialogLabels.pcPointDialog.emptyLabel),this.options.asyncMatch||this.updateUserList())}revisePCCheckDialogLabel(t){!this.options.needDialog||this.options.asyncMatch||(this.options.dialogLabels.pcPCheckDialog=Object.assign({},J,t||{}),this.chatElement.pcElms.checkDialogElm.querySelector(".checkbox-dialog-container-header").children[0].textContent=this.options.dialogLabels.pcPCheckDialog.title,this.chatElement.pcElms.checkDialogSearchInputElm.setAttribute("placeholder",this.options.dialogLabels.pcPCheckDialog.searchPlaceholder),this.chatElement.pcElms.checkDialogElm.querySelector(".checkbox-dialog-search-empty").textContent=this.options.dialogLabels.pcPCheckDialog.searchEmptyLabel,this.chatElement.pcElms.checkDialogElm.querySelector(".checkbox-dialog-right-box-title").textContent=this.options.dialogLabels.pcPCheckDialog.userTagTitle,this.chatElement.pcElms.checkDialogUsersElm.children[0].children[2].textContent=this.options.dialogLabels.pcPCheckDialog.checkAllLabel,this.chatElement.pcElms.checkDialogElm.querySelector(".btn-submit").textContent=this.options.dialogLabels.pcPCheckDialog.confirmLabel,this.chatElement.pcElms.checkDialogElm.querySelector(".btn-close").textContent=this.options.dialogLabels.pcPCheckDialog.cancelLabel)}reviseH5DialogLabel(t){this.options.needDialog&&(this.options.dialogLabels.h5Dialog=Object.assign({},Q,t||{}),this.chatElement.h5Elms.dialogElm.querySelector(".popup-title").textContent=this.options.dialogLabels.h5Dialog.title,this.chatElement.h5Elms.dialogSearchElm.setAttribute("placeholder",this.options.dialogLabels.h5Dialog.searchPlaceholder),this.chatElement.h5Elms.dialogEmptyElm.children[1].textContent=this.options.dialogLabels.h5Dialog.searchEmptyLabel,this.chatElement.h5Elms.dialogCheckElm.textContent=this.options.dialogLabels.h5Dialog.confirmLabel,this.chatElement.h5Elms.dialogShowElm.textContent=this.options.dialogLabels.h5Dialog.cancelLabel,this.options.asyncMatch||this.updateUserList())}createOperateNode(){return new It(this)}async nextTick(t){return new Promise(e=>{requestAnimationFrame(()=>{const i=t();i instanceof Promise?i.then(()=>{e()}):e()})})}}if(!window)throw new Error("非web环境！");window.console&&window.console.log&&console.log(" %c ".concat("ChatArea"," %c v5.6.3 "),"background: #269AFF; color: #FFFFFF; padding: 4px 0; border-radius: 4px 0px 0px 4px; font-style: italic;","background: #FFFFFF; color: #269AFF; padding: 2px 0; border-radius: 0px 4px 4px 0px; font-style: italic; border: 2px solid #269AFF;");window.ChatArea=vt;
